# Implementation Plan: Terminal Font Settings

Generated: 2026-01-19

## Goal

Add user-configurable terminal font settings (font family and font size) to the Portal app. Users should be able to:
1. Choose from a list of monospace fonts (JetBrains Mono, Fira Code, Source Code Pro, SF Mono, Menlo)
2. Adjust terminal font size

## Research Summary

### Current Implementation
- Terminal is rendered via xterm.js in a WebView
- Terminal HTML is generated by `buildTerminalHtml()` in `/home/gabrielolv/Documents/Projects/ter/lib/terminal-html.ts`
- Current font config is hardcoded at line ~173:
  ```typescript
  fontFamily: '"JetBrains Mono", Menlo, monospace',
  fontSize: config.fontSize,
  ```
- Font sizes are hardcoded per profile:
  - `logs`: 11
  - `docker`: 12
  - `session`: 12

### Store Architecture
- Preferences managed via Zustand-style React Context in `/home/gabrielolv/Documents/Projects/ter/lib/store.tsx`
- Types defined in `/home/gabrielolv/Documents/Projects/ter/lib/types.ts`
- Defaults in `/home/gabrielolv/Documents/Projects/ter/lib/defaults.ts`
- Persistence via `loadPreferences()`/`savePreferences()` in `lib/storage.ts`

### Settings UI Pattern
- Settings screen at `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/more.tsx`
- Uses `Card` components with `MenuItem`, `ToggleItem`, and custom selectors (see `ThemeOption`)
- Pattern for segmented controls already exists (theme selector)

### Terminal Consumers
Three files use `buildTerminalHtml()`:
1. `/home/gabrielolv/Documents/Projects/ter/app/session/[hostId]/[name]/terminal.tsx` - Tmux sessions
2. `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/terminal.tsx` - Docker exec
3. `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/logs.tsx` - Docker logs

### Google Fonts Integration
The terminal HTML already loads JetBrains Mono from Google Fonts. Other fonts will need similar loading.

## Existing Codebase Analysis

### Key Files
| File | Purpose | Changes Needed |
|------|---------|----------------|
| `lib/types.ts` | Type definitions | Add `TerminalSettings` type |
| `lib/defaults.ts` | Default preferences | Add terminal defaults |
| `lib/store.tsx` | State management | Add `updateTerminalSettings()` |
| `lib/terminal-html.ts` | Terminal HTML generation | Accept font settings, load fonts |
| `app/(tabs)/more.tsx` | Settings UI | Add font settings section |

### Existing Patterns to Follow
1. **Preference updates**: Use same pattern as `updateTheme()` and `updateNotificationSettings()`
2. **UI components**: Reuse `MenuItem`, `Card`, segmented control pattern from theme selector
3. **Type extensions**: Follow `AppPreferences` structure

## Implementation Phases

### Phase 1: Type Definitions and Store

**Files to modify:**
- `/home/gabrielolv/Documents/Projects/ter/lib/types.ts` - Add types
- `/home/gabrielolv/Documents/Projects/ter/lib/defaults.ts` - Add defaults
- `/home/gabrielolv/Documents/Projects/ter/lib/store.tsx` - Add update function

**Steps:**

1. Add terminal font type to `lib/types.ts`:
```typescript
export type TerminalFontFamily =
  | 'JetBrains Mono'
  | 'Fira Code'
  | 'Source Code Pro'
  | 'SF Mono'
  | 'Menlo';

export type TerminalSettings = {
  fontFamily: TerminalFontFamily;
  fontSize: number;
};
```

2. Extend `AppPreferences` in `lib/types.ts`:
```typescript
export type AppPreferences = {
  usageCards: UsageCardsVisibility;
  theme: ThemeSetting;
  notifications: {
    pushEnabled: boolean;
    liveEnabled: boolean;
  };
  terminal: TerminalSettings;  // Add this
};
```

3. Update `defaultPreferences()` in `lib/defaults.ts`:
```typescript
export function defaultPreferences(): AppPreferences {
  return {
    usageCards: { claude: true, codex: true, copilot: true },
    theme: 'system',
    notifications: { pushEnabled: true, liveEnabled: true },
    terminal: {
      fontFamily: 'JetBrains Mono',
      fontSize: 12,
    },
  };
}
```

4. Add `updateTerminalSettings()` to `lib/store.tsx`:
```typescript
const updateTerminalSettings = useCallback(
  (updates: Partial<TerminalSettings>) => {
    setPreferences((prev) => {
      const next: AppPreferences = {
        ...prev,
        terminal: { ...prev.terminal, ...updates },
      };
      savePreferences(next);
      return next;
    });
  },
  []
);
```

5. Add to context type and value in `lib/store.tsx`

**Acceptance criteria:**
- [x] `TerminalFontFamily` and `TerminalSettings` types exist
- [x] `AppPreferences` includes `terminal` field
- [x] `defaultPreferences()` returns terminal defaults
- [x] `updateTerminalSettings()` persists changes

---

### Phase 2: Terminal HTML Font Loading

**Files to modify:**
- `/home/gabrielolv/Documents/Projects/ter/lib/terminal-html.ts` - Accept font settings, load correct fonts

**Steps:**

1. Add font configuration type to `terminal-html.ts`:
```typescript
export type TerminalFontConfig = {
  fontFamily: string;
  fontSize: number;
};

const FONT_FAMILIES: Record<string, { css: string; google?: string }> = {
  'JetBrains Mono': {
    css: '"JetBrains Mono", monospace',
    google: 'JetBrains+Mono:wght@400;500',
  },
  'Fira Code': {
    css: '"Fira Code", monospace',
    google: 'Fira+Code:wght@400;500',
  },
  'Source Code Pro': {
    css: '"Source Code Pro", monospace',
    google: 'Source+Code+Pro:wght@400;500',
  },
  'SF Mono': {
    css: '"SF Mono", SFMono-Regular, monospace',
    google: undefined, // System font, no Google Fonts
  },
  'Menlo': {
    css: 'Menlo, monospace',
    google: undefined, // System font
  },
};
```

2. Update `TerminalHtmlConfig` type to include font settings:
```typescript
type TerminalHtmlConfig = {
  // ... existing fields
  fontFamily: string;
  fontSize: number;
};
```

3. Update `buildConfig()` function signature and pass font settings:
```typescript
function buildConfig(
  profile: TerminalHtmlProfile,
  wsUrl: string,
  theme: TerminalTheme,
  font: TerminalFontConfig
): TerminalHtmlConfig {
  // Use font.fontFamily and font.fontSize
  // Keep profile-specific size only for logs (smaller)
}
```

4. Update `buildTerminalHtml()` signature:
```typescript
export function buildTerminalHtml(
  profile: TerminalHtmlProfile,
  wsUrl: string,
  theme: TerminalTheme,
  font: TerminalFontConfig
): string
```

5. Generate dynamic Google Fonts link based on selected font:
```typescript
function getGoogleFontsLink(fontFamily: string): string {
  const fontConfig = FONT_FAMILIES[fontFamily];
  if (!fontConfig?.google) return '';
  return `<link href="https://fonts.googleapis.com/css2?family=${fontConfig.google}&display=swap" rel="stylesheet" />`;
}
```

6. Update terminal options generation:
```typescript
const termOptions = {
  // ...
  fontFamily: FONT_FAMILIES[font.fontFamily]?.css || '"JetBrains Mono", monospace',
  fontSize: profile === 'logs' ? 11 : font.fontSize,
  // ...
};
```

**Acceptance criteria:**
- [x] `buildTerminalHtml()` accepts font config
- [x] Google Fonts only loaded when needed
- [x] System fonts (SF Mono, Menlo) work without Google Fonts
- [x] Logs profile uses smaller fixed size (11)

---

### Phase 3: Update Terminal Consumers

**Files to modify:**
- `/home/gabrielolv/Documents/Projects/ter/app/session/[hostId]/[name]/terminal.tsx`
- `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/terminal.tsx`
- `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/logs.tsx`

**Steps:**

1. Import preferences from store in each terminal screen:
```typescript
const { preferences } = useStore();
```

2. Pass font settings to `buildTerminalHtml()`:
```typescript
const fontConfig = {
  fontFamily: preferences.terminal.fontFamily,
  fontSize: preferences.terminal.fontSize,
};

// In source generation:
{ html: buildTerminalHtml('session', wsUrl, terminalTheme, fontConfig) }
```

3. Update cache key to include font settings (already uses `themeKey`, add `fontKey`):
```typescript
const fontKey = `${preferences.terminal.fontFamily}|${preferences.terminal.fontSize}`;
const cacheKey = `${wsUrl}|${themeKey}|${fontKey}|${TERMINAL_HTML_VERSION}|session`;
```

**Acceptance criteria:**
- [x] All three terminal screens pass font config
- [x] WebView cache invalidates when font settings change
- [x] Terminal re-renders with new font when settings change

---

### Phase 4: Settings UI

**Files to modify:**
- `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/more.tsx` - Add Terminal section

**Steps:**

1. Add font options constant:
```typescript
const FONT_OPTIONS: { label: string; value: TerminalFontFamily }[] = [
  { label: 'JetBrains Mono', value: 'JetBrains Mono' },
  { label: 'Fira Code', value: 'Fira Code' },
  { label: 'Source Code Pro', value: 'Source Code Pro' },
  { label: 'SF Mono', value: 'SF Mono' },
  { label: 'Menlo', value: 'Menlo' },
];

const FONT_SIZE_OPTIONS = [10, 11, 12, 13, 14, 15, 16];
```

2. Create `FontOption` component (similar to `ThemeOption`):
```typescript
interface FontOptionProps {
  label: string;
  value: TerminalFontFamily;
  selected: boolean;
  onSelect: (value: TerminalFontFamily) => void;
  styles: ReturnType<typeof createStyles>;
  colors: ThemeColors;
}

function FontOption({ label, value, selected, onSelect, styles, colors }: FontOptionProps) {
  return (
    <Pressable
      onPress={() => onSelect(value)}
      style={[styles.fontOption, selected && { backgroundColor: colors.accent }]}
    >
      <AppText
        variant="label"
        style={{ color: selected ? colors.accentText : colors.text }}
      >
        {label}
      </AppText>
    </Pressable>
  );
}
```

3. Create `FontSizeSelector` component with +/- buttons:
```typescript
function FontSizeSelector({ value, onChange, styles, colors }) {
  return (
    <View style={styles.fontSizeSelector}>
      <Pressable onPress={() => onChange(Math.max(10, value - 1))} style={styles.fontSizeButton}>
        <AppText variant="title">-</AppText>
      </Pressable>
      <AppText variant="subtitle">{value}px</AppText>
      <Pressable onPress={() => onChange(Math.min(16, value + 1))} style={styles.fontSizeButton}>
        <AppText variant="title">+</AppText>
      </Pressable>
    </View>
  );
}
```

4. Add Terminal Settings card to the screen (after Appearance card):
```typescript
<Card style={styles.card}>
  <View style={styles.sectionHeader}>
    <AppText variant="subtitle">Terminal</AppText>
    <AppText variant="label" tone="muted">
      Customize terminal appearance
    </AppText>
  </View>
  <View style={styles.separator} />

  <View style={styles.settingRow}>
    <AppText variant="label">Font</AppText>
    <ScrollView horizontal showsHorizontalScrollIndicator={false}>
      <View style={styles.fontSelector}>
        {FONT_OPTIONS.map((opt) => (
          <FontOption
            key={opt.value}
            label={opt.label}
            value={opt.value}
            selected={preferences.terminal.fontFamily === opt.value}
            onSelect={(val) => updateTerminalSettings({ fontFamily: val })}
            styles={styles}
            colors={colors}
          />
        ))}
      </View>
    </ScrollView>
  </View>
  <View style={styles.separator} />

  <View style={styles.settingRow}>
    <AppText variant="label">Size</AppText>
    <FontSizeSelector
      value={preferences.terminal.fontSize}
      onChange={(size) => updateTerminalSettings({ fontSize: size })}
      styles={styles}
      colors={colors}
    />
  </View>
</Card>
```

5. Add styles for new components:
```typescript
fontOption: {
  paddingVertical: theme.spacing.xs,
  paddingHorizontal: theme.spacing.sm,
  borderRadius: theme.radii.sm,
  backgroundColor: colors.separator,
  marginRight: theme.spacing.xs,
},
fontSelector: {
  flexDirection: 'row',
  padding: theme.spacing.md,
},
fontSizeSelector: {
  flexDirection: 'row',
  alignItems: 'center',
  gap: theme.spacing.md,
},
fontSizeButton: {
  width: 32,
  height: 32,
  borderRadius: 16,
  backgroundColor: colors.separator,
  alignItems: 'center',
  justifyContent: 'center',
},
settingRow: {
  padding: theme.spacing.md,
  gap: theme.spacing.sm,
},
```

**Acceptance criteria:**
- [x] Font family selector shows all 5 options
- [x] Font size can be adjusted with +/- buttons
- [x] Selected option is visually highlighted
- [x] Changes persist after app restart
- [x] Settings match existing UI style

---

## Testing Strategy

### Manual Testing
1. Change font family and verify terminal updates
2. Change font size and verify terminal updates
3. Test all 5 font options render correctly
4. Test size range limits (10-16)
5. Verify settings persist after app restart
6. Test each terminal type (session, docker exec, docker logs)
7. Verify logs terminal keeps smaller fixed size

### Edge Cases
- Test with fonts that may not be available on all devices
- Test font loading with slow network (Google Fonts)
- Test cache invalidation when switching fonts rapidly

## Risks and Considerations

1. **Font Loading Latency**: Google Fonts need to load before terminal renders correctly. The existing `document.fonts.ready` handling should cover this.

2. **System Font Availability**: SF Mono may not be available on Android. The CSS fallback chain handles this gracefully.

3. **Migration**: Existing users won't have `terminal` in their preferences. The store should merge defaults:
```typescript
const storedPreferences = await loadPreferences();
setPreferences({ ...defaultPreferences(), ...storedPreferences });
```
   This is already handled by the existing store pattern.

4. **Cache Invalidation**: Need to ensure WebView cache includes font settings in key to force re-render.

## Estimated Complexity

| Phase | Effort | Risk |
|-------|--------|------|
| Phase 1: Types & Store | Low | Low |
| Phase 2: Terminal HTML | Medium | Low |
| Phase 3: Consumer Updates | Low | Low |
| Phase 4: Settings UI | Medium | Low |

**Total: ~2-3 hours implementation time**

## File Summary

Files to create: None

Files to modify:
1. `/home/gabrielolv/Documents/Projects/ter/lib/types.ts`
2. `/home/gabrielolv/Documents/Projects/ter/lib/defaults.ts`
3. `/home/gabrielolv/Documents/Projects/ter/lib/store.tsx`
4. `/home/gabrielolv/Documents/Projects/ter/lib/terminal-html.ts`
5. `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/more.tsx`
6. `/home/gabrielolv/Documents/Projects/ter/app/session/[hostId]/[name]/terminal.tsx`
7. `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/terminal.tsx`
8. `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/logs.tsx`
