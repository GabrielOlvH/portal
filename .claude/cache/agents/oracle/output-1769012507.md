# Research Report: OpenCode Session/Conversation History Storage
Generated: 2026-01-21

## Summary

OpenCode (the open-source AI coding assistant) uses a hybrid storage approach combining SQLite database for indexed queries with JSON files for session/message persistence. Sessions are stored hierarchically at `~/.local/share/opencode/storage/` with separate directories for sessions, messages, and message parts. The system supports programmatic session resume via CLI flags (`--session`/`-s`) and a TypeScript/Go SDK.

## Questions Answered

### Q1: Where are sessions stored (file paths, database, etc.)?
**Answer:** Sessions are stored in `~/.local/share/opencode/storage/` with the following structure:
- `session/<project-hash>/<session-id>.json` - Session metadata
- `message/<session-id>/msg_<message-id>.json` - Individual messages
- `part/msg_<message-id>/` - Message parts (tool calls, text, reasoning, etc.)
- `session_diff/<session-id>.json` - File change tracking
- `session-metadata/<project-id>/<session-id>.json` - Custom metadata

The path can be customized via `OPENCODE_DATA_DIR` environment variable.
**Source:** [DeepWiki Session Management](https://deepwiki.com/sst/opencode/2.1-session-management), [Train.sh OpenCode Notes](https://train.sh/blog/2025-12-opencode-notes/)
**Confidence:** High

### Q2: What is the file format?
**Answer:** OpenCode uses a hybrid approach:
1. **SQLite database** - For indexed queries and persistent storage of conversations
2. **JSON files** - For individual session and message data storage
3. **JSONC** (JSON with comments) - Supported for configuration files

Each session directory contains `.json` files, and each message from that session is saved as a separate JSON file.
**Source:** [OpenCode CLI Docs](https://opencode.ai/docs/cli/), [GitHub README](https://github.com/opencode-ai/opencode)
**Confidence:** High

### Q3: Schema/structure of session data
**Answer:** 

**Session Schema (Session.Info):**
```json
{
  "id": "ses_xxx",
  "parentID": "ses_parent",  // For subagent sessions
  "title": "Session title",
  "directory": "/path/to/project",
  "version": "1.0",
  "createdAt": "2026-01-21T...",
  "updatedAt": "2026-01-21T...",
  "summaryMessageID": "msg_xxx"  // Links to compaction summary
}
```

**Message Schema (AssistantMessage from Go SDK):**
```go
type AssistantMessage struct {
    ID         string
    ParentID   string
    SessionID  string
    ModelID    string
    ProviderID string
    Role       string
    Cost       float64
    Tokens     TokenInfo
    Time       TimeInfo
    System     []string
    Error      ErrorInfo
    Summary    bool
}
```

**Part Types:** Messages contain multiple parts representing different content types:
- `text` - Regular text content
- `tool` - Tool calls and results
- `reasoning` - AI reasoning/thinking
- `file` - File references
- `patch` - Code patches
- `snapshot` - State snapshots

Parts maintain references to both parent message and session.

**Source:** [DeepWiki Session Management](https://deepwiki.com/sst/opencode/2.1-session-management), [Go SDK Package](https://pkg.go.dev/github.com/sst/opencode-sdk-go)
**Confidence:** High

### Q4: How to resume sessions programmatically
**Answer:** Multiple approaches available:

**CLI Flags:**
```bash
# Resume specific session
opencode --session <session_id>
opencode -s <session_id>

# Continue most recent session (feature request - may not be stable)
opencode --continue
```

**TUI Commands:**
```
/sessions    # List and switch sessions
/resume      # Alias for /sessions
/continue    # Alias for /sessions
```

**TypeScript SDK:**
```typescript
import { OpenCode } from "@opencode-ai/sdk"

const client = new OpenCode()
const session = await client.session.get(sessionId)
const messages = await client.message.list(sessionId)
```

**MCP Server (for programmatic access):**
```python
opencode_continue_session(session_id="abc123", message="Continue with this...")
```

**Export/Import:**
```bash
# Export session to JSON
opencode session export <session_id> > session.json

# Import session from JSON or share URL
opencode session import session.json
opencode session import https://opencode.ai/share/xxx
```

**Source:** [OpenCode CLI Docs](https://opencode.ai/docs/cli/), [OpenCode MCP Server](https://github.com/nosolosoft/opencode-mcp), [SDK Docs](https://opencode.ai/docs/sdk/)
**Confidence:** High

## Detailed Findings

### Finding 1: Storage Architecture
**Source:** [DeepWiki - Session Management](https://deepwiki.com/sst/opencode/2.1-session-management)

OpenCode uses a hierarchical storage system:

```
~/.local/share/opencode/
└── storage/
    ├── session/<project-hash>/
    │   └── ses_xxx.json           # Session metadata
    ├── message/<session-id>/
    │   └── msg_xxx.json           # Individual messages
    ├── part/<message-id>/
    │   └── part_xxx.json          # Message parts (tool calls, etc.)
    ├── session_diff/<session-id>.json  # File changes
    └── session-metadata/<project>/<session>.json  # Custom metadata
```

The storage implementation supports atomic updates through `Storage.update()` method which applies editor functions to draft objects before persistence.

### Finding 2: Context Management and Compaction
**Source:** [DeepWiki - Context Management](https://deepwiki.com/sst/opencode/2.4-context-management-and-compaction)

OpenCode handles context window limits through:
- **Auto-compaction**: Automatically summarizes conversations approaching token limits
- **Selective pruning**: Removes verbose tool outputs while preserving essential context
- **SummaryMessageID**: Links to a message containing summary of prior conversation
- **Hierarchical sessions**: Child sessions can inherit context from parent via `parentID`

### Finding 3: SDK and API Types
**Source:** [OpenCode SDK Docs](https://opencode.ai/docs/sdk/)

The `@opencode-ai/sdk` package provides TypeScript types auto-generated from `packages/sdk/openapi.json`:

**Key type files:**
- `packages/sdk/js/src/v2/gen/types.gen.ts` - Part types (lines 72-431)
- `packages/sdk/js/src/v2/gen/sdk.gen.ts` - SDK client code

**Available event types (30+):**
- `session.created`, `session.updated`, `session.removed`
- `message.created`, `message.updated`, `message.removed`
- `message.part.updated`, `message.part.removed`

### Finding 4: Session Sharing
**Source:** [DeepWiki - Session Sharing](https://deepwiki.com/sst/opencode/6.6-session-sharing)

Sessions can be shared publicly via:
1. **Share Creation**: CLI generates unique share URL and secret token
2. **SyncServer**: Cloudflare Durable Object manages WebSocket connections
3. **R2 Persistence**: Data written to R2 bucket for durability
4. **Web Viewer**: SolidJS application displays messages with live sync

## Comparison Matrix

| Storage Method | Format | Use Case | Persistence |
|----------------|--------|----------|-------------|
| File-based (JSON) | JSON files | Session/message storage | Local disk |
| SQLite | Database | Indexed queries, search | Local disk |
| R2 + Durable Objects | Cloud | Shared sessions | Cloudflare |
| Export/Import | JSON | Backup/transfer | Portable |

## Recommendations

### For Programmatic Session Access
1. **Use the TypeScript SDK** (`@opencode-ai/sdk`) for type-safe access to sessions
2. **Read JSON files directly** from `~/.local/share/opencode/storage/` for quick local access
3. **Use `opencode session export`** for portable session snapshots

### Implementation Notes
- Session IDs use format `ses_<unique-id>`
- Message IDs use format `msg_<unique-id>`
- Subagent sessions have `parentID` field set
- Project hash determines session grouping
- The `OPENCODE_DATA_DIR` env var can override storage location

## Sources

1. [OpenCode GitHub Repository](https://github.com/opencode-ai/opencode) - Main source code
2. [OpenCode CLI Documentation](https://opencode.ai/docs/cli/) - CLI commands and flags
3. [OpenCode SDK Documentation](https://opencode.ai/docs/sdk/) - TypeScript SDK usage
4. [DeepWiki - Session Management](https://deepwiki.com/sst/opencode/2.1-session-management) - Internal architecture
5. [DeepWiki - Context Management](https://deepwiki.com/sst/opencode/2.4-context-management-and-compaction) - Compaction system
6. [Go SDK Package](https://pkg.go.dev/github.com/sst/opencode-sdk-go) - Go type definitions
7. [OpenCode MCP Server](https://github.com/nosolosoft/opencode-mcp) - Programmatic integration
8. [Train.sh OpenCode Analysis](https://train.sh/blog/2025-12-opencode-notes/) - Technical notes

## Open Questions

- Exact SQLite schema tables and indexes (not publicly documented)
- Precise format of exported session JSON (would need to test with actual export)
- Rate limits or constraints on SDK API calls
- Whether session compaction can be triggered programmatically
