# Codebase Report: Portal App Exploration
Generated: 2026-01-27 16:02:00

## Summary

Portal (formerly "Bridge") is a **React Native mobile app** built with **Expo** that manages tmux sessions and Docker containers across multiple remote hosts. It includes a Node.js agent that runs on servers and a network discovery feature to find local agents.

## App Type & Tech Stack

### Platform
- **React Native 0.81.5** with **Expo 54** (cross-platform mobile: iOS/Android/Web)
- Uses Expo Router for file-based routing
- New Architecture enabled

### Key Dependencies
- **@tanstack/react-query** - Server state management
- **@react-native-community/netinfo** - Network information (used for discovery)
- **Hono** - Agent backend framework
- **expo-notifications** - Push notifications
- **expo-live-activity** - iOS Live Activities
- **@gorhom/bottom-sheet** - Bottom sheet UI
- **lucide-react-native** - Icon library

## Project Structure

```
portal/
├── app/                    # Expo Router screens (file-based routing)
│   ├── (tabs)/            # Bottom tab navigation
│   │   ├── hosts.tsx      # Hosts list + network scanning
│   │   ├── index.tsx      # Dashboard
│   │   ├── more.tsx       # Settings
│   │   └── projects.tsx   # Projects list
│   ├── hosts/             # Host management screens
│   │   ├── new.tsx        # Add new host
│   │   └── [id]/
│   │       ├── index.tsx  # Host details
│   │       └── edit.tsx   # Edit host
│   ├── session/           # Terminal session screens
│   │   └── [hostId]/[name]/
│   │       ├── index.tsx  # Session details
│   │       └── terminal.tsx # Full terminal view
│   ├── projects/          # Project management
│   ├── snippets/          # Quick commands
│   ├── ai-sessions/       # AI session history
│   ├── ports/             # Port management
│   ├── cli-assets/        # CLI asset management
│   └── copilot/           # GitHub Copilot auth
│
├── lib/                   # Core business logic & utilities
│   ├── api.ts             # REST API client (40+ endpoints)
│   ├── types.ts           # TypeScript type definitions
│   ├── store.tsx          # React Context state management
│   ├── discovery.ts       # Network scanning for agents ✓
│   ├── storage.ts         # AsyncStorage persistence
│   ├── theme.ts           # Theme definitions
│   ├── useTheme.tsx       # Theme hook
│   ├── query.tsx          # React Query configuration
│   ├── notifications.ts   # Push notification handling
│   ├── live.tsx           # Live session updates
│   ├── docker-hooks.ts    # Docker React Query hooks
│   └── terminal-html.ts   # Terminal rendering HTML
│
├── components/            # React Native UI components
│   ├── HostCard.tsx       # Host display card
│   ├── SessionCard.tsx    # Terminal session card
│   ├── TerminalWebView.tsx # Terminal WebView wrapper
│   ├── LaunchSheet.tsx    # Command launch bottom sheet
│   ├── CreateTunnelModal.tsx # Port forwarding UI
│   ├── DirectoryBrowser.tsx # File system browser
│   └── ...                # Other UI components
│
└── agent/                 # Node.js server (runs on remote hosts)
    ├── src/
    │   ├── index.ts       # Agent entry point
    │   ├── server.ts      # Hono HTTP server
    │   ├── tmux.ts        # Tmux session management
    │   ├── docker.ts      # Docker API wrapper
    │   ├── ports.ts       # Port scanning/management
    │   ├── tunnels.ts     # SSH tunnel management
    │   ├── agents.ts      # AI agent detection
    │   ├── claude.ts      # Claude CLI integration
    │   ├── codex.ts       # Codex integration
    │   ├── copilot.ts     # GitHub Copilot integration
    │   ├── cursor.ts      # Cursor integration
    │   ├── usage.ts       # Usage tracking/polling
    │   ├── git.ts         # Git status
    │   └── notifications/ # Push notification system
    └── install.sh         # systemd service installer
```

## Architecture Map

```
[Mobile App (React Native + Expo)]
            |
            | HTTP REST + WebSocket
            v
[Agent (Node.js + Hono)] ─────> [tmux sessions]
            |                    [Docker containers]
            |                    [Port scanning]
            |                    [SSH tunnels]
            |                    [AI CLI tools]
            v
    [systemd service]
```

## Key Features Discovered

### 1. Host Management
**Entry Point:** `/home/gabriel/Projects/Personal/portal/app/(tabs)/hosts.tsx`

Manages multiple server connections with:
- Per-host auth tokens
- Color coding
- Online/offline status
- Last seen timestamps

### 2. Network Discovery (Existing Functionality!)
**Location:** `/home/gabriel/Projects/Personal/portal/lib/discovery.ts`

**IMPORTANT:** The app already has network scanning functionality!

#### How It Works:
1. Uses `@react-native-community/netinfo` to get device IP address and subnet
2. Derives target IP range from local network (default: /24 subnet)
3. Scans for agents on port 4020 (configurable)
4. Uses `probeHealth()` API call with concurrent workers
5. Filters out already-added hosts

#### Key Functions:
- `scanForAgents()` - Main scan coordinator
- `deriveTargets()` - Generates IP list from subnet
- `buildExistingHostSet()` - Prevents duplicate hosts
- `probeHealth()` (in api.ts) - Tests if agent is reachable

#### Configuration:
```typescript
const DEFAULT_PORT = 4020;
const DEFAULT_TIMEOUT_MS = 1200;
const DEFAULT_CONCURRENCY = 30;  // Parallel probes
const MAX_DERIVED_HOSTS = 512;   // Safety limit
```

#### Usage Pattern (from hosts.tsx):
```typescript
const result = await scanForAgents({ hosts });
// Returns: { results: DiscoveredAgent[], error?: string }
```

### 3. API Layer
**Location:** `/home/gabriel/Projects/Personal/portal/lib/api.ts`

40+ REST endpoints including:
- Session management: `getSessions()`, `createSession()`, `killSession()`
- Docker: `dockerContainerAction()`
- Ports: `getPorts()`, `killPorts()`
- Tunnels: `getTunnels()`, `createTunnel()`, `closeTunnel()`
- Updates: `checkForUpdate()`, `applyUpdate()`
- Notifications: `registerNotificationDevice()`, `sendTestPushNotification()`
- AI Sessions: Track Claude/Codex/Copilot usage
- CLI Assets: Manage skills, MCPs, rules, agents

### 4. State Management
**Location:** `/home/gabriel/Projects/Personal/portal/lib/store.tsx`

React Context provider with:
- `hosts: Host[]` - Server connections
- `preferences: AppPreferences` - User settings
- `upsertHost()` - Add/update host
- `removeHost()` - Delete host
- `updateHostLastSeen()` - Track connectivity
- Persisted to AsyncStorage

### 5. Terminal Integration
**Components:**
- `TerminalWebView.tsx` - WebView wrapper for xterm.js
- `terminal-html.ts` - HTML/JS for xterm rendering
- WebSocket connection for terminal I/O

### 6. Docker Management
**Location:** `/home/gabriel/Projects/Personal/portal/agent/src/docker.ts`

Container, image, volume, network management via Docker CLI.

### 7. Port Management & Tunneling
**Locations:**
- `agent/src/ports.ts` - Port scanning with `lsof`/`ss`
- `agent/src/tunnels.ts` - SSH tunnel creation/management
- UI: `CreateTunnelModal.tsx`, `TunnelRow.tsx`

### 8. AI Integration
Tracks usage for:
- Claude CLI (`agent/src/claude.ts`)
- Codex (`agent/src/codex.ts`)
- GitHub Copilot (`agent/src/copilot.ts`)
- Cursor (`agent/src/cursor.ts`)

## Type System

### Core Types (from types.ts):

```typescript
// Host connection
type Host = {
  id: string;
  name: string;
  baseUrl: string;      // e.g., "http://192.168.1.100:4020"
  authToken?: string;
  color?: ColorValue;
  lastSeen?: number;
};

// Discovery result
type DiscoveredAgent = {
  ip: string;
  baseUrl: string;
  label: string;
  status: 'ok' | 'auth-required';
  tmuxVersion?: string;
};

// Terminal session
type Session = {
  name: string;
  windows: number;
  attached: boolean;
  preview?: string[];
  insights?: SessionInsights;
};

// Docker container
type DockerContainer = {
  id: string;
  name: string;
  image: string;
  status?: string;
  state?: string;
  cpuPercent?: number;
  memoryPercent?: number;
  // ... more fields
};

// Port info
type PortInfo = {
  pid: number;
  port: number;
  process: string;
  protocol?: 'tcp' | 'udp';
};

// SSH tunnel
type Tunnel = {
  id: string;
  listenPort: number;
  targetHost: string;
  targetPort: number;
  status: 'active' | 'error' | 'closed';
  connections: number;
};

// AI session tracking
type AiSession = {
  id: string;
  provider: 'claude' | 'codex' | 'opencode';
  directory: string;
  summary: string;
  messageCount: number;
  tokenUsage?: AiSessionTokenUsage;
  modifiedFiles: string[];
};
```

## Conventions

### Naming
- **Files:** kebab-case (`host-card.tsx`, `api.ts`)
- **Components:** PascalCase (`HostCard`, `SessionCard`)
- **Functions:** camelCase (`scanForAgents`, `probeHealth`)
- **Types:** PascalCase (`Host`, `Session`, `DiscoveredAgent`)

### File Organization
- Screens in `app/` directory (Expo Router convention)
- Business logic in `lib/` directory
- Reusable UI in `components/` directory
- Server code in `agent/` directory

### Patterns
| Pattern | Usage | Example |
|---------|-------|---------|
| React Context | Global state | `StoreProvider`, `useStore()` |
| React Query | Server state | `useQuery()` for API calls |
| Async/Await | All async ops | API calls, storage |
| Typed props | All components | TypeScript interfaces |
| Custom hooks | State logic | `useTheme()`, `useStore()` |

### Testing
- No test files found in project
- Uses `tsc --noEmit` for type checking
- Has `oxlint` for linting

## Agent Architecture

The Node.js agent runs on remote servers as a systemd service:

1. **HTTP Server (Hono)** - REST API on port 4020
2. **WebSocket Server** - Terminal I/O streaming
3. **Background Workers** - Usage polling, notifications
4. **systemd Integration** - Auto-start, logging via journalctl

### Agent Endpoints (from agent/src/http/):
- `/health` - System info
- `/sessions/*` - Tmux management
- `/docker/*` - Container operations
- `/ports/*` - Port management
- `/tunnels/*` - SSH tunnels
- `/agents/*` - AI CLI detection
- `/notifications/*` - Push notification registration
- `/update/*` - Self-update mechanism

## Questions Answered

### Q1: What kind of app is this?
**Answer:** React Native mobile app (iOS/Android) built with Expo for managing remote Linux servers.

### Q2: What's the tech stack?
**Answer:**
- **Frontend:** React Native 0.81.5 + Expo 54 + Expo Router
- **State:** React Context + TanStack Query
- **Backend:** Node.js + Hono (Cloudflare-style framework)
- **UI:** Custom components + Bottom Sheet + Lucide icons
- **Networking:** `@react-native-community/netinfo` for discovery

### Q3: Where are features/services defined?
**Answer:**
- **API Client:** `/home/gabriel/Projects/Personal/portal/lib/api.ts`
- **Types:** `/home/gabriel/Projects/Personal/portal/lib/types.ts`
- **State:** `/home/gabriel/Projects/Personal/portal/lib/store.tsx`
- **Discovery:** `/home/gabriel/Projects/Personal/portal/lib/discovery.ts`
- **Agent Services:** `/home/gabriel/Projects/Personal/portal/agent/src/`

### Q4: Is there existing networking functionality?
**Answer:** YES! `/home/gabriel/Projects/Personal/portal/lib/discovery.ts` implements:
- Local network scanning
- IP range derivation from subnet
- Concurrent agent probing
- Duplicate host filtering
- WiFi detection and validation

The discovery feature is already integrated in the hosts screen at:
`/home/gabriel/Projects/Personal/portal/app/(tabs)/hosts.tsx`

## Key Files Reference

| File | Purpose | Key Exports |
|------|---------|-------------|
| `lib/api.ts` | REST API client | 40+ endpoint functions |
| `lib/types.ts` | Type definitions | All TypeScript types |
| `lib/store.tsx` | Global state | `StoreProvider`, `useStore()` |
| `lib/discovery.ts` | Network scanning | `scanForAgents()` ✓ |
| `app/(tabs)/hosts.tsx` | Host management UI | Scan feature integration |
| `agent/src/index.ts` | Agent entry point | Server startup |
| `agent/src/server.ts` | HTTP server | Hono app setup |
| `agent/src/tmux.ts` | Tmux wrapper | Session management |
| `agent/src/ports.ts` | Port scanning | `lsof`/`ss` integration |
| `agent/src/tunnels.ts` | SSH tunnels | Tunnel lifecycle |

## Open Questions

1. **What specific networking feature are you planning to add?** The app already has local network discovery for finding agents. Are you looking to:
   - Add mDNS/Bonjour service discovery?
   - Implement remote network scanning (scan from agent, not client)?
   - Add network diagnostics (ping, traceroute)?
   - Improve the existing discovery with better subnet detection?

2. **Performance considerations:** Current discovery scans up to 512 IPs with 30 concurrent probes. This is reasonable for /24 subnets but might need tuning for larger networks.

3. **Security:** Auth tokens are optional. Consider whether discovery should auto-detect auth requirements (it already does via `auth-required` status).
