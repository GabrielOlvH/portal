# Codebase Report: Terminal Session Naming Architecture
Generated: 2026-01-25

## Summary

This React Native/Expo app manages remote tmux terminal sessions on Linux servers. Session names are **user-generated timestamps** (`projectName-timestamp` or `session-timestamp`) and displayed throughout the UI. The backend queries tmux for session metadata, and while tmux **does track** the running process command (`pane_current_command`), it's **only used for AI insights**, not for session naming or UI display.

## Session Naming Flow

### 1. Session Creation (Frontend)

**Location:** `components/LaunchSheet.tsx`

Sessions are created in 3 scenarios:

#### A. Project Launch (lines 810-840)
```typescript
const timestamp = Date.now().toString(36);
const sessionName = `${selectedProject.name}-${timestamp}`;

await createSession(selectedHost, sessionName);
await sendText(selectedHost, sessionName, `cd ${selectedProject.path}\n`);
await sendText(selectedHost, sessionName, `${command.command}\n`);
```

**Pattern:** `projectName-base36timestamp`  
**Example:** `myapp-l8k3j2n9`

#### B. Blank Session (lines 842-857)
```typescript
const sessionName = `session-${Date.now().toString(36)}`;
await createSession(selectedHost, sessionName);
```

**Pattern:** `session-base36timestamp`  
**Example:** `session-l8k3j45x`

#### C. Blank + Snippet (lines 859-869)
```typescript
const sessionName = `session-${Date.now().toString(36)}`;
await createSession(selectedHost, sessionName);
await sendText(selectedHost, sessionName, `${snippet.command}\n`);
```

**Pattern:** Same as blank session

### 2. Session Creation (Backend)

**Location:** `agent/src/http/routes/sessions.ts` (lines 44-59)

```typescript
app.post('/sessions', async (c) => {
  const name = requireName(body.name);  // Validates name exists
  const windowName = body.windowName;
  const command = body.command;
  
  const args = ['new-session', '-d', '-s', name];
  if (windowName) args.push('-n', windowName);
  if (command) args.push(command);
  
  await runTmux(args);
  await runTmux(['set-option', '-t', name, 'status', 'off']);
});
```

**Tmux command:** `tmux new-session -d -s <name>`  
- `-d` = detached
- `-s <name>` = session name (from frontend)

### 3. Session Listing (Backend)

**Location:** `agent/src/sessions.ts` (lines 3-9)

```typescript
export async function listSessions(): Promise<string> {
  return runTmux([
    'list-sessions',
    '-F',
    '#{session_name}||#{session_windows}||#{session_created}||#{session_attached}||#{session_last_attached}',
  ]);
}
```

**Returns:** Tmux session metadata (name, window count, timestamps, attached status)

**Location:** `agent/src/tmux.ts` (lines 33-47)

```typescript
export function parseSessions(raw: string): TmuxSessionInfo[] {
  return raw.split('\n').map((line) => {
    const [name, windows, createdAt, attached, lastAttached] = line.split('||');
    return {
      name,                    // ← Session name from tmux
      windows: Number(windows),
      attached: attached === '1',
      createdAt: created * 1000,
      lastAttached: last * 1000,
    };
  });
}
```

## Session Display (Frontend)

### A. Session Card

**Location:** `components/SessionCard.tsx` (lines 38-90)

```typescript
export function SessionCard({ session, host, onPress, onKill }: SessionCardProps) {
  // ...
  return (
    <Card onPress={onPress}>
      <AppText>{session.name}</AppText>  {/* ← Displays tmux session name */}
    </Card>
  );
}
```

**Displays:** `session.name` directly from tmux

### B. Terminal Screen

**Location:** `app/session/[hostId]/[name]/terminal.tsx` (lines 112-174)

```typescript
export default function SessionTerminalScreen() {
  const params = useLocalSearchParams<{ hostId: string; name: string }>();
  const initialSessionName = decodeURIComponent(params.name ?? '');
  
  const [currentSessionName, setCurrentSessionName] = useState(initialSessionName);
  
  // Build WebSocket URL with session name
  const wsUrl = buildWsUrl(host, sessionName);
  // ws://host:4020/ws?session=<name>&cols=80&rows=24
}
```

**Route:** `/session/[hostId]/[name]/terminal`  
**Example:** `/session/host123/myapp-l8k3j2n9/terminal`

### C. WebSocket Connection

**Location:** `app/session/[hostId]/[name]/terminal.tsx` (lines 101-110)

```typescript
function buildWsUrl(host: { baseUrl: string; authToken?: string }, sessionName: string): string {
  const base = new URL(host.baseUrl);
  const protocol = base.protocol === 'https:' ? 'wss:' : 'ws:';
  const token = host.authToken ? `&token=${encodeURIComponent(host.authToken)}` : '';
  return `${protocol}//${base.host}/ws?session=${encodeURIComponent(sessionName)}&cols=80&rows=24${token}`;
}
```

**WebSocket URL:** `ws://host:4020/ws?session=myapp-l8k3j2n9&cols=80&rows=24`

## Process Name Detection (Backend Only)

**Location:** `agent/src/agents.ts` (line 75)

```typescript
const paneInfo = await runTmux([
  'list-panes',
  '-t', sessionTarget(name),
  '-F',
  '#{pane_active}||#{pane_current_command}||#{pane_start_command}||#{pane_pid}||#{pane_current_path}',
]);
```

**Tmux variables:**
- `#{pane_current_command}` - Currently running command (e.g., `node`, `vim`, `bash`)
- `#{pane_start_command}` - Initial command that started the pane
- `#{pane_pid}` - Process ID

**Usage:** AI-powered session insights (not for naming/display)

## Type Definitions

**Location:** `lib/types.ts` (lines 14-22)

```typescript
export type Session = {
  name: string;           // Session name (from tmux)
  windows: number;        // Number of tmux windows
  attached: boolean;      // Is someone attached?
  createdAt?: number;     // Timestamp
  lastAttached?: number;  // Last attach timestamp
  preview?: string[];     // Terminal preview lines
  insights?: SessionInsights;  // AI insights (includes process info)
};
```

## API Endpoints

**Location:** `agent/README.md` & `lib/api.ts`

| Endpoint | Method | Purpose | Session Name Usage |
|----------|--------|---------|-------------------|
| `POST /sessions` | Create | `{ name: "myapp-l8k3j2n9" }` | Sets tmux session name |
| `GET /sessions` | List | Returns all sessions | Includes `name` field |
| `POST /sessions/:name/rename` | Rename | `{ name: "new-name" }` | Changes tmux session name |
| `POST /sessions/:name/kill` | Kill | - | Targets session by name |
| `GET /ws?session=<name>` | WebSocket | Terminal I/O | Attaches to session by name |

## Key Files

| File | Purpose | Session Name Handling |
|------|---------|----------------------|
| `components/LaunchSheet.tsx` | Session creation UI | **Generates** session names |
| `lib/api.ts` | API client | Passes session names to backend |
| `components/SessionCard.tsx` | Session list item | **Displays** `session.name` |
| `app/session/[hostId]/[name]/terminal.tsx` | Terminal UI | URL param → WebSocket connection |
| `components/TerminalWebView.tsx` | WebView wrapper | Renders xterm.js terminal |
| `lib/terminal-html.ts` | Terminal HTML generator | Builds xterm.js HTML with theme/font |
| `agent/src/sessions.ts` | Backend session listing | Calls `tmux list-sessions` |
| `agent/src/http/routes/sessions.ts` | Session API routes | Creates/renames/kills sessions |
| `agent/src/tmux.ts` | Tmux command utilities | Parses tmux output |
| `agent/src/agents.ts` | AI insights | Queries `pane_current_command` |

## Architecture Flow

```
[User taps "Launch"]
        ↓
[LaunchSheet generates: projectName-timestamp]
        ↓
[API: POST /sessions { name: "myapp-l8k3j2n9" }]
        ↓
[Backend: tmux new-session -d -s myapp-l8k3j2n9]
        ↓
[Frontend: Navigate to /session/host123/myapp-l8k3j2n9/terminal]
        ↓
[WebSocket: ws://host:4020/ws?session=myapp-l8k3j2n9]
        ↓
[Backend: tmux attach to session "myapp-l8k3j2n9" via PTY]
        ↓
[Frontend: xterm.js renders terminal in WebView]
```

## Session Name Sources

| Source | Where Used | Format |
|--------|------------|--------|
| **Generated (Frontend)** | `LaunchSheet.tsx` | `projectName-timestamp` or `session-timestamp` |
| **Stored (Tmux)** | Backend session list | Whatever name was used at creation |
| **Displayed (UI)** | `SessionCard`, terminal header | Exact tmux session name |
| **URL Param** | Router navigation | URI-encoded session name |
| **WebSocket Query** | Terminal connection | URI-encoded session name |

## Process Name Availability

**VERIFIED:** The backend **does have access** to the running process name via:

```bash
tmux list-panes -t <session> -F '#{pane_current_command}'
```

**Current Usage:** AI insights only (`agent/src/agents.ts`)

**Potential Usage:** Could be used for:
1. Displaying process name instead of session name in UI
2. Auto-naming sessions based on running process
3. Filtering/searching sessions by process type
4. Session icons based on process (e.g., node, vim, docker)

## Open Questions

1. **Should session names display the process instead of timestamp?**
   - Current: `myapp-l8k3j2n9`
   - Alternative: `myapp (node)` or `myapp - node server.js`

2. **Should sessions auto-rename based on running process?**
   - Tmux allows renaming: `POST /sessions/:name/rename`
   - Could poll `pane_current_command` and update name

3. **Should the UI show both session name + process?**
   - Card header: `myapp-l8k3j2n9`
   - Subtitle: `Running: node server.js`
