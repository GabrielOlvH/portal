# Docker Container Management - Codebase Analysis
Generated: 2026-01-19

## Summary

The app provides comprehensive Docker container management across multiple remote hosts through a clean architecture:
- **Backend**: Docker CLI wrapper with JSON parsing and caching
- **API**: REST endpoints for snapshots and container actions
- **Frontend**: React Native UI with live WebSocket updates
- **Data layer**: Hooks aggregate containers from all hosts with compose project grouping

## Architecture Flow

```
[Mobile UI] --> [useAllDocker hook] --> [useHostsLive] --> [WebSocket] --> [Agent API]
                                                                              |
                                                                         [/docker routes]
                                                                              |
                                                                    [docker.ts wrapper]
                                                                              |
                                                                      [Docker CLI]
```

## 1. Backend Docker Integration

### File: `/home/gabrielolv/Documents/Projects/ter/agent/src/docker.ts`

**Purpose**: Docker CLI wrapper that executes commands and parses JSON output

**Key Functions**:

| Function | Purpose | Details |
|----------|---------|---------|
| `getDockerSnapshot()` | Main entry point | Returns cached snapshot (5s TTL) or builds new one |
| `buildDockerSnapshot()` | Fetch all Docker data | Runs 5 parallel commands: ps, stats, images, volumes, networks |
| `runDockerContainerAction()` | Execute container actions | Validates action in allowed set: start, stop, restart, pause, unpause, kill |
| `parseJsonLines()` | Parse Docker JSON output | Handles newline-delimited JSON from `docker --format '{{json .}}'` |
| `parseMemoryUsage()` | Parse memory strings | Converts "1.5GiB / 4GiB" to bytes |
| `parsePercent()` | Parse percentage strings | Extracts numeric value from "45.2%" |

**Caching Strategy**:
```typescript
const dockerCache: {
  ts: number;                              // Last build timestamp
  value: DockerSnapshot | null;            // Cached snapshot
  inflight: Promise<DockerSnapshot> | null; // Prevent duplicate builds
}
```
- 5-second cache TTL
- Deduplicates simultaneous requests via `inflight` promise
- Graceful degradation: returns old cache on errors

**Docker Commands Executed**:
```bash
docker ps -a --no-trunc --format '{{json .}}'          # All containers
docker stats --no-stream --no-trunc --format '{{json .}}' # Resource usage
docker images --no-trunc --format '{{json .}}'         # Images
docker volume ls --format '{{json .}}'                 # Volumes
docker network ls --format '{{json .}}'                # Networks
```

**Data Enrichment**:
- Joins `ps` and `stats` by container ID/name
- Parses Docker Compose labels (`com.docker.compose.project`, `com.docker.compose.service`)
- Converts memory/CPU percentages to numbers
- Extracts ports, network I/O, block I/O

### File: `/home/gabrielolv/Documents/Projects/ter/agent/src/http/routes/docker.ts`

**API Endpoints**:

| Endpoint | Method | Purpose | Handler |
|----------|--------|---------|---------|
| `/docker` | GET | Fetch full Docker snapshot | `getDockerSnapshot()` |
| `/docker/containers/:id/:action` | POST | Execute container action | `runDockerContainerAction(id, action)` |

**Actions Supported**: `start`, `stop`, `restart`, `pause`, `unpause`, `kill`

**Error Handling**:
- Returns 400 for invalid actions
- Uses `jsonError()` helper for consistent error responses

## 2. Data Types

### File: `/home/gabrielolv/Documents/Projects/ter/lib/types.ts`

**DockerContainer** (19 fields):
```typescript
{
  id: string;                    // Container ID
  name: string;                  // Container name
  image: string;                 // Image name
  state?: string;                // running, exited, etc.
  status?: string;               // "Up 2 hours", "Exited (0) 5 days ago"
  ports?: string;                // "0.0.0.0:8080->80/tcp"
  createdAt?: string;
  runningFor?: string;
  cpuPercent?: number;           // Numeric CPU usage
  memoryPercent?: number;        // Numeric memory percentage
  memoryUsage?: string;          // "1.5GiB / 4GiB"
  memoryUsedBytes?: number;      // Parsed bytes
  memoryLimitBytes?: number;
  netIO?: string;                // "1.2MB / 3.4MB"
  blockIO?: string;
  pids?: number;
  labels?: Record<string, string>;
  composeProject?: string;       // Extracted from labels
  composeService?: string;
}
```

**DockerSnapshot**:
```typescript
{
  available: boolean;     // Docker installed and working
  error?: string;         // "docker not installed" or error message
  containers: DockerContainer[];
  images: DockerImage[];
  volumes: DockerVolume[];
  networks: DockerNetwork[];
}
```

## 3. Live Data Integration

### File: `/home/gabrielolv/Documents/Projects/ter/lib/live.tsx`

**WebSocket Options**:
```typescript
type HostLiveOptions = {
  sessions?: boolean;  // Include tmux sessions
  docker?: boolean;    // Include Docker snapshot
  intervalMs?: number; // Refresh rate (default varies)
  enabled?: boolean;   // Pause updates when false
};
```

**LiveSnapshotMessage**:
```typescript
{
  type: 'snapshot';
  ts?: number;
  sessions?: Session[];
  host?: HostInfo;
  docker?: DockerSnapshot;  // Docker data merged into live updates
}
```

**State Merging**:
The live hook merges Docker snapshots into state:
```typescript
docker: payload.docker ?? prev.docker,
```
This allows selective updates (only Docker data can update without re-fetching sessions).

**Connection Parameters**:
When `docker: true` is set, the WebSocket URL includes `?docker=1`, triggering the agent to include Docker data in live snapshots.

## 4. React Hooks Layer

### File: `/home/gabrielolv/Documents/Projects/ter/lib/docker-hooks.ts`

**useAllDocker()** - Main aggregation hook

**Returns**:
```typescript
{
  containers: ContainerWithHost[];    // All containers with host metadata
  running: ContainerWithHost[];       // Filtered running containers
  stopped: ContainerWithHost[];       // Filtered stopped containers
  refreshAll: () => void;             // Refresh all hosts
  refreshHost: (hostId: string) => void;
  hosts: Host[];                      // All configured hosts
  isLoading: boolean;                 // True while checking hosts
  hasDocker: boolean;                 // True if any host has Docker
}
```

**ContainerWithHost** (extended type):
```typescript
DockerContainer & {
  host: Host;              // Host reference
  hostStatus: HostStatus;  // 'online', 'offline', 'checking'
}
```

**Implementation Pattern**:
1. Calls `useHostsLive(hosts, { docker: true })` to get live data for all hosts
2. Flattens containers from all hosts into single array
3. Enriches each container with `host` and `hostStatus` metadata
4. Provides filtered views (running/stopped)
5. Computes aggregate flags (isLoading, hasDocker)

**Helper Functions**:
```typescript
isContainerRunning(container) // Checks state === 'running' || status.startsWith('up')
formatBytes(bytes)            // Converts bytes to "1.5 GB" format
```

## 5. UI Components

### File: `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/docker.tsx`

**Docker Tab Screen** - Unified container view across all hosts

**Features**:
- Summary stats: Running/Stopped/Hosts counts
- Groups containers by Compose project
- Expandable/collapsible groups
- Pull-to-refresh
- Empty states for no hosts/no Docker

**Compose Grouping Logic**:
```typescript
type ComposeGroup = {
  key: string;              // `${hostId}:${project || 'standalone'}`
  title: string;            // Project name or "Standalone"
  hostName: string;
  hostColor: string;
  containers: ContainerWithHost[];
  running: number;
  stopped: number;
  isStandalone: boolean;    // True if no compose project
};
```

**Sorting**:
1. Compose projects first, standalone containers last
2. Alphabetically by project/container name
3. Within groups: running containers first

**UI Patterns**:

| Component | Pattern | Visual |
|-----------|---------|--------|
| Summary bar | 3-column stats | `28 Running | 5 Stopped | 3 Hosts` |
| Group header | Chevron + title + host dot + stats | `â–¼ myapp â€¢ server1 â— 2 ðŸŸ¢ 1` |
| Container row | Dot + name + meta + actions | `â— nginx cpu:12% mem:512MB [Terminal][Stop]` |
| Empty state | Card with CTA | "No Docker available" + Refresh button |

**Actions**:
- Tap group header: Expand/collapse
- Tap container row: Navigate to detail view
- Tap Terminal button: Navigate to terminal
- Tap Start/Stop button: Confirm alert â†’ API call â†’ refresh

**Loading States**:
1. `!ready`: Show skeleton list
2. `hosts.length === 0`: Show "Add host" CTA
3. `isLoading`: Show skeleton list
4. `!hasDocker && containers.length === 0`: Show "No Docker" message

### File: `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/index.tsx`

**Container Detail Screen**

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Back â”‚ Container Name â”‚ Terminal â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status Card                  â”‚
â”‚ Status: running  CPU: 12%   â”‚
â”‚                Memory: 512MB â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Controls                     â”‚
â”‚ [Stop] [Restart] [Pause] [Kill]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Details                      â”‚
â”‚ ID: abc123...                â”‚
â”‚ Image: nginx:latest          â”‚
â”‚ Ports: 0.0.0.0:80->80/tcp   â”‚
â”‚ Running: 2 hours             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Status Card** - 3-column layout:
- Status (colored: green=running, red=stopped)
- CPU percentage
- Memory usage (formatted or raw bytes)

**Action Buttons**:
- Conditional visibility: Show Stop OR Start based on state
- Pause/Unpause toggle based on state
- Kill button always visible (danger tone)
- Alert confirmation before execution
- Disabled during action execution
- Shows "Working..." label during action

**Detail Rows**:
- ID (truncated with ellipsis)
- Image name
- Ports (if present, up to 2 lines)
- Running duration (if present)

**Error States**:
1. Host not found: "Host not found" message
2. Docker unavailable: Shows error from snapshot
3. Container not found: "Container not found" message

**Navigation**:
- Back button: `router.back()`
- Terminal button: `/hosts/${hostId}/docker/${containerId}/terminal`

## 6. API Client

### File: `/home/gabrielolv/Documents/Projects/ter/lib/api.ts`

**dockerContainerAction()**:
```typescript
async function dockerContainerAction(
  host: Host,
  containerId: string,
  action: 'start' | 'stop' | 'restart' | 'pause' | 'unpause' | 'kill'
): Promise<{ ok: boolean }>
```

**Implementation**:
```typescript
return request(host, `/docker/containers/${encodeURIComponent(containerId)}/${action}`, {
  method: 'POST',
});
```

**URL Encoding**: Container ID is URI-encoded to handle special characters in container names.

## UI Patterns Summary

### Container State Indicators

**Status Dot Colors**:
- Running: `colors.accent` (blue) with pulsing animation
- Stopped: `colors.textMuted` (gray), static

**Status Text Colors**:
- Running: `colors.green`
- Stopped: `colors.red`

### Card Hierarchy

```
GlassCard (group)
â”œâ”€ Header (pressable, controls expand/collapse)
â”‚  â”œâ”€ Chevron icon (right/down)
â”‚  â”œâ”€ Title + host indicator
â”‚  â””â”€ Stats badges (running/stopped counts)
â””â”€ Containers (when expanded)
   â””â”€ Row per container (pressable)
      â”œâ”€ Status dot
      â”œâ”€ Info (name + metadata)
      â””â”€ Actions (Terminal + Start/Stop)
```

### Action Flow

**Start/Stop Container**:
1. User taps action button
2. Alert dialog confirms action
3. If confirmed:
   - Set `actionInProgress` state
   - Call `dockerContainerAction(host, id, action)`
   - On success: `refreshHost(hostId)` to update live data
   - On error: Alert with error message
   - Finally: Clear `actionInProgress`

**Navigate to Terminal**:
1. User taps Terminal button or container row
2. Navigate to `/hosts/${hostId}/docker/${containerId}/terminal`
3. Terminal screen handles WebSocket connection for container exec

### Responsive Patterns

**Pull-to-Refresh**:
```typescript
<RefreshControl
  refreshing={manualRefresh}
  onRefresh={handleRefresh}
  tintColor={systemColors.blue}
/>
```

**Skeleton Loading**:
```typescript
<SkeletonList type="container" count={4} />
```
Matches container card layout with pulsing animation.

**Auto-refresh**:
- Enabled when screen is focused (`isFocused`)
- Disabled when unfocused to save resources
- Controlled via `useAllDocker({ enabled: isFocused })`

## Key Files Reference

| File | Purpose | Entry Points |
|------|---------|--------------|
| `/home/gabrielolv/Documents/Projects/ter/agent/src/docker.ts` | Docker CLI wrapper | `getDockerSnapshot()`, `runDockerContainerAction()` |
| `/home/gabrielolv/Documents/Projects/ter/agent/src/http/routes/docker.ts` | REST API routes | `GET /docker`, `POST /docker/containers/:id/:action` |
| `/home/gabrielolv/Documents/Projects/ter/lib/docker-hooks.ts` | Data aggregation hooks | `useAllDocker()`, `isContainerRunning()` |
| `/home/gabrielolv/Documents/Projects/ter/lib/live.tsx` | WebSocket live updates | `useHostsLive(hosts, { docker: true })` |
| `/home/gabrielolv/Documents/Projects/ter/lib/api.ts` | API client | `dockerContainerAction()` |
| `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/docker.tsx` | Main Docker tab UI | `DockerTabScreen` component |
| `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/docker/[containerId]/index.tsx` | Container detail UI | `DockerContainerScreen` component |

## API Endpoints

| Endpoint | Method | Request | Response | Usage |
|----------|--------|---------|----------|-------|
| `/docker` | GET | None | `DockerSnapshot` | Fetch all Docker data (containers, images, volumes, networks) |
| `/docker/containers/:id/:action` | POST | `{ id, action }` | `{ ok: true }` | Execute container action (start, stop, restart, pause, unpause, kill) |

## Data Flow Examples

### Listing All Containers

```
1. User opens Docker tab
2. DockerTabScreen renders
3. useAllDocker() called
   â””â”€> useHostsLive(hosts, { docker: true })
       â””â”€> Opens WebSocket with ?docker=1
           â””â”€> Agent calls getDockerSnapshot()
               â””â”€> Executes docker ps, stats, etc.
               â””â”€> Parses JSON, enriches data
               â””â”€> Returns snapshot
           â””â”€> Sends via WebSocket
       â””â”€> Hook merges snapshot into state
   â””â”€> Aggregates containers from all hosts
   â””â”€> Returns { containers, running, stopped, ... }
4. UI groups by compose project
5. Renders expandable group cards
```

### Stopping a Container

```
1. User taps Stop button
2. Alert confirmation shown
3. User confirms
4. dockerContainerAction(host, containerId, 'stop')
   â””â”€> POST /docker/containers/${id}/stop
       â””â”€> runDockerContainerAction(id, 'stop')
           â””â”€> execFile('docker', ['stop', containerId])
       â””â”€> Returns { ok: true }
5. refreshHost(hostId) triggers WebSocket refresh
6. New snapshot arrives, UI updates
```

## Conventions Discovered

### Naming
- Hooks: `useAllDocker`, `useHostsLive` (React hooks pattern)
- Components: `DockerTabScreen`, `DockerContainerScreen` (Screen suffix)
- Types: `DockerContainer`, `DockerSnapshot` (PascalCase)
- Actions: lowercase strings ('start', 'stop', etc.)

### File Organization
- Backend: `agent/src/docker.ts`, `agent/src/http/routes/docker.ts`
- Frontend hooks: `lib/docker-hooks.ts`, `lib/live.tsx`
- UI screens: `app/(tabs)/docker.tsx`, `app/hosts/[id]/docker/[containerId]/index.tsx`
- Types: `lib/types.ts` (shared types)
- API client: `lib/api.ts` (centralized request functions)

### Error Handling
- Backend: Returns `{ available: false, error: string }` in snapshot
- API routes: Returns 400 with `{ error: string }` for invalid requests
- Frontend: Shows Alert dialogs for user-facing errors
- Live updates: Graceful degradation with cached data

### State Management
- Global store: `useStore()` for hosts configuration
- Live state: `useHostsLive()` for real-time data
- Local state: `useState()` for UI interactions (refresh, expand, actions)
- Memos: `useMemo()` for expensive computations (grouping, filtering)

### Performance Optimizations
- 5-second backend cache prevents Docker CLI spam
- Inflight promise deduplication
- WebSocket-based live updates (push vs poll)
- Conditional fetching based on screen focus
- Memoized computed values (groups, filters)
- Skeleton loaders during initial load

## Open Questions

None - the implementation is complete and well-structured.

## Additional Notes

**Compose Project Detection**:
The app detects Docker Compose projects via labels and groups containers accordingly. This provides better organization for multi-container applications.

**Terminal Integration**:
The app includes a separate terminal screen (`terminal.tsx`) for executing interactive shells in containers, using WebSocket for real-time terminal I/O (not analyzed in this report).

**Live Updates**:
The WebSocket integration allows the UI to show real-time updates as containers start/stop/change state, without requiring manual refresh.

**Multi-host Support**:
The architecture cleanly handles multiple hosts, aggregating containers from all sources and displaying them in a unified view while maintaining host attribution.
