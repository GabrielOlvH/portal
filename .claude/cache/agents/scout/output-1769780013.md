# Notification System Analysis
Generated: 2026-01-30

## Summary

The Portal app has a comprehensive push notification system split between:
- **Mobile app** (`lib/notifications.ts`) - Handles device registration and local notifications via expo-notifications
- **Agent backend** (`agent/src/notifications/`) - Monitors state changes and sends push notifications via Expo Push Service

Two main notification types:
1. **Task Pause Notifications** - Alert when agent transitions from running → idle (after 30s minimum run time)
2. **Usage Reset Notifications** - Alert when AI provider usage limits reset (only if usage was below 50% threshold)

## File Locations

### Mobile App (Expo/React Native)
| File | Purpose |
|------|---------|
| `/home/gabriel/Projects/Personal/portal/lib/notifications.ts` | Core notification setup, permissions, device registration |
| `/home/gabriel/Projects/Personal/portal/lib/ongoing-notifications.ts` | Android ongoing notifications (via Notifee) |
| `/home/gabriel/Projects/Personal/portal/app/_layout.tsx` | App bootstrap - registers/unregisters notifications based on preferences |
| `/home/gabriel/Projects/Personal/portal/app/(tabs)/more.tsx` | Settings UI - test notifications, toggle push settings |

### Agent Backend (Node.js)
| File | Purpose |
|------|---------|
| `/home/gabriel/Projects/Personal/portal/agent/src/notifications/pause-monitor.ts` | Monitors agent state transitions (running → idle) |
| `/home/gabriel/Projects/Personal/portal/agent/src/notifications/reset-monitor.ts` | Monitors AI provider usage limit resets |
| `/home/gabriel/Projects/Personal/portal/agent/src/notifications/push.ts` | Sends push notifications via Expo Push Service |
| `/home/gabriel/Projects/Personal/portal/agent/src/notifications/registry.ts` | Device registry (stores push tokens) |
| `/home/gabriel/Projects/Personal/portal/agent/src/http/routes/notifications.ts` | HTTP API for device registration and test notifications |
| `/home/gabriel/Projects/Personal/portal/agent/src/index.ts` | Starts notification monitors on app boot |
| `/home/gabriel/Projects/Personal/portal/agent/src/config.ts` | Configuration constants |

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Mobile App (Expo)                      │
├─────────────────────────────────────────────────────────────┤
│  lib/notifications.ts                                       │
│  - setupNotifications() → request permissions               │
│  - registerNotificationsForHosts() → send token to agent    │
│  - sendTestNotification() → local notification              │
│                                                             │
│  app/_layout.tsx                                            │
│  - On mount: register if preferences.notifications.enabled │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP POST /notifications/register
                       │ {deviceId, expoPushToken, platform}
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                   Agent Backend (Node)                      │
├─────────────────────────────────────────────────────────────┤
│  agent/src/notifications/registry.ts                        │
│  - Store push tokens in ~/.tmux-agent/notifications/        │
│                                                             │
│  agent/src/index.ts                                         │
│  - setInterval(startPauseMonitor, 15s)                      │
│  - setInterval(startResetMonitor, 60s)                      │
│                                                             │
│  Monitors (poll periodically):                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ pause-monitor.ts                                     │  │
│  │ - Polls tmux sessions every 15s                      │  │
│  │ - Detects running → idle (after 30s min runtime)     │  │
│  │ - Sends "Task paused" notification                   │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ reset-monitor.ts                                     │  │
│  │ - Polls usage API every 60s                          │  │
│  │ - Detects limit resets (percentLeft jumps up)        │  │
│  │ - Only notifies if was below 50% threshold           │  │
│  │ - Sends "Weekly Limit Reset" notification            │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  push.ts                                                    │
│  - sendExpoPushMessages(messages)                           │
│  - Batches up to 100 messages                               │
│  - POSTs to https://exp.host/--/api/v2/push/send           │
└─────────────────────────────────────────────────────────────┘
```

## Notification Triggers

### 1. Task Pause Notifications
**File:** `agent/src/notifications/pause-monitor.ts`

**When triggered:**
- Agent state transitions from `running` → `idle`
- Agent must have been running for at least **30 seconds** (prevents spam on quick tasks)

**Frequency control:**
```typescript
// Line 62-64
const durationMs = startedAt ? Date.now() - startedAt : 0;
if (previous === 'running' && durationMs >= 30000) {
  messages.push(...buildMessages(session.name, HOST_LABEL, devices));
}
```

**Polling interval:** Every **15 seconds** (configurable via `TMUX_AGENT_NOTIFICATION_POLL_MS`)

**Message format:**
```typescript
{
  title: 'Task paused',
  body: '{sessionName} on {hostLabel} is idle',
  channelId: 'task-updates',
  data: { type: 'task-paused', sessionName, host }
}
```

### 2. Usage Reset Notifications
**File:** `agent/src/notifications/reset-monitor.ts`

**When triggered:**
- AI provider usage limit resets (session or weekly window)
- Previous usage was below **50%** threshold (configurable via `TMUX_AGENT_RESET_THRESHOLD`)
- Reset detected by:
  - Reset timestamp changed, OR
  - Percent available jumped up by >20%

**Rate limit logic:**
```typescript
// Line 73
const wasConstrained = previousPercent < RESET_NOTIFY_THRESHOLD;

// Line 76-85
if (resetDetected && wasConstrained) {
  return {
    provider,
    window: windowType,
    previousPercent,
    currentPercent,
  };
}
```

**Polling interval:** Every **60 seconds** (configurable via `TMUX_AGENT_RESET_MONITOR_MS`)

**Message format:**
```typescript
{
  title: 'Weekly Limit Reset' or 'Usage Reset',
  body: '{provider} {window} limit reset - {percent}% capacity available',
  channelId: 'usage-resets',
  data: { type: 'usage-reset', provider, window, percentLeft, host }
}
```

**Providers monitored:** Claude, Codex, Copilot, Cursor

## Rate Limiting & Frequency Control

### Configuration Constants
**File:** `agent/src/config.ts`

```typescript
// Line 12-14
export const NOTIFICATION_POLL_INTERVAL = Number(process.env.TMUX_AGENT_NOTIFICATION_POLL_MS || 15000);
export const RESET_MONITOR_INTERVAL = Number(process.env.TMUX_AGENT_RESET_MONITOR_MS || 60000);
export const RESET_NOTIFY_THRESHOLD = Number(process.env.TMUX_AGENT_RESET_THRESHOLD || 50);
```

### Spam Prevention Mechanisms

| Mechanism | Implementation | Purpose |
|-----------|----------------|---------|
| **Minimum run time** | `durationMs >= 30000` in pause-monitor.ts:62 | Prevent notifications for tasks that run <30s |
| **State tracking** | `lastStates` Map in pause-monitor.ts:10 | Only notify on state *transitions*, not continuous states |
| **Usage threshold** | `previousPercent < RESET_NOTIFY_THRESHOLD` in reset-monitor.ts:73 | Only notify reset if user was actually constrained |
| **Reset detection** | Track previous reset timestamps in reset-monitor.ts:45 | Avoid duplicate notifications for same reset |
| **Inflight prevention** | `if (inflight) return` in both monitors | Prevent concurrent polls from same monitor |
| **Device filtering** | `devices.length === 0` check | Don't poll if no devices registered |

### Frequency Summary

| Notification Type | Poll Interval | Minimum Trigger Delay | Configurable Via |
|-------------------|---------------|----------------------|------------------|
| Task Pause | 15s | 30s runtime | `TMUX_AGENT_NOTIFICATION_POLL_MS` |
| Usage Reset | 60s | Threshold-based | `TMUX_AGENT_RESET_MONITOR_MS`, `TMUX_AGENT_RESET_THRESHOLD` |

## Push Notification Flow

### Device Registration
1. Mobile app calls `setupNotifications()` → requests permissions
2. Gets Expo Push Token from Expo service
3. Generates unique `deviceId` (stored in AsyncStorage)
4. POSTs to `POST /notifications/register` with `{deviceId, expoPushToken, platform}`
5. Agent stores in `~/.tmux-agent/notifications/devices.json`

### Notification Sending
1. Monitor detects trigger condition (pause-monitor or reset-monitor)
2. Calls `listNotificationDevices()` → loads registered devices
3. Builds message array (one message per device)
4. Calls `sendExpoPushMessages(messages)` from push.ts
5. Batches messages (max 100 per batch)
6. POSTs to Expo Push Service: `https://exp.host/--/api/v2/push/send`
7. Expo delivers to mobile devices

### Device Storage
**Location:** `~/.tmux-agent/notifications/devices.json`

**Format:**
```json
{
  "device-abc123": {
    "deviceId": "device-abc123",
    "expoPushToken": "ExponentPushToken[xxxxxx]",
    "platform": "android",
    "updatedAt": 1706640000000
  }
}
```

## Notification Channels

### Android Channels
**File:** `lib/notifications.ts`

```typescript
// Line 35-43 - Created during setup
{
  id: 'task-updates',
  name: 'Task updates',
  importance: Notifications.AndroidImportance.HIGH,
  vibrationPattern: [0, 250, 250, 250],
  lightColor: '#59A6FF',
  sound: 'default'
}
```

**Channel usage:**
- `task-updates` - Used by pause notifications
- `usage-resets` - Used by reset notifications (defined in reset-monitor.ts:142)

### Ongoing Notifications (Android only)
**File:** `lib/ongoing-notifications.ts`

Uses `@notifee/react-native` for persistent notifications:
```typescript
// Line 33-48
updateOngoingNotification(title: string, body: string)
clearOngoingNotification()
```

**Purpose:** Show persistent notification for long-running tasks (doesn't auto-dismiss)

## Key Functions

### Mobile App

**setupNotifications()** - `lib/notifications.ts:75`
- Requests notification permissions
- Creates Android channel
- Gets Expo Push Token
- Returns: `{status, deviceId, expoPushToken}`

**registerNotificationsForHosts(hosts)** - `lib/notifications.ts:109`
- Calls setupNotifications()
- POSTs to each host's `/notifications/register` endpoint
- Stores registration in AsyncStorage

**sendTestNotification()** - `lib/notifications.ts:200`
- Schedules local notification (no server involved)
- Returns: `{status: 'success'|'denied'|'error', id?, message?}`

### Agent Backend

**startPauseMonitor()** - `agent/src/notifications/pause-monitor.ts:77`
- Called every 15s from agent/src/index.ts:40
- Polls tmux sessions
- Detects state transitions
- Sends "Task paused" notifications

**startResetMonitor()** - `agent/src/notifications/reset-monitor.ts:173`
- Called every 60s from agent/src/index.ts:47
- Polls usage snapshot
- Detects limit resets
- Sends "Limit reset" notifications

**sendExpoPushMessages(messages)** - `agent/src/notifications/push.ts:26`
- Batches messages (max 100)
- POSTs to Expo Push Service
- Handles errors from Expo API

## API Endpoints

**POST /notifications/register** - `agent/src/http/routes/notifications.ts:17`
- Body: `{deviceId, expoPushToken, platform}`
- Stores device in registry
- Returns: `{ok: true, device: {...}}`

**DELETE /notifications/register** - `agent/src/http/routes/notifications.ts:36`
- Body: `{deviceId}`
- Removes device from registry
- Returns: `{ok: boolean}`

**GET /notifications/register** - `agent/src/http/routes/notifications.ts:50`
- Lists all registered devices
- Returns: `{ok: true, devices: [...]}`

**POST /notifications/test** - `agent/src/http/routes/notifications.ts:59`
- Body: `{title?, body?}` (optional)
- Sends test push to all registered devices
- Returns: `{ok: true, count: number}`

## Usage-Related Notification Logic

### Threshold Configuration
**Default:** 50% - Only notify if usage was below 50% before reset

**Environment variable:** `TMUX_AGENT_RESET_THRESHOLD`

**Logic:**
```typescript
// reset-monitor.ts:73
const wasConstrained = previousPercent < RESET_NOTIFY_THRESHOLD;
```

### Reset Detection
**Tracked per provider + window:**
- Claude: session, weekly
- Codex: session, weekly
- Copilot: session, weekly
- Cursor: session, weekly

**State tracking:**
```typescript
// reset-monitor.ts:18-19
const lastResets = new Map<ResetKey, string>(); // Previous reset timestamp
const lastPercents = new Map<ResetKey, number>(); // Previous percent available
```

**Detection criteria:**
1. Reset timestamp changed (new cycle), OR
2. Percent available jumped >20% (line 68)

**AND** previous usage was below threshold (line 73)

### Example Scenarios

| Scenario | Previous % | Current % | Notify? | Reason |
|----------|-----------|-----------|---------|--------|
| Heavy user, reset | 25% | 100% | ✅ Yes | Was constrained (25% < 50%) |
| Light user, reset | 80% | 100% | ❌ No | Wasn't constrained (80% >= 50%) |
| No reset | 40% | 38% | ❌ No | No reset detected |
| First poll | N/A | 100% | ❌ No | No previous data |

## Preferences & Settings

**Type definition:** `lib/types.ts:55`
```typescript
notifications: {
  pushEnabled: boolean;
  liveEnabled: boolean;
}
```

**Defaults:** `lib/defaults.ts:24`
```typescript
notifications: {
  pushEnabled: true,
  liveEnabled: true
}
```

**Storage:** Persisted in AsyncStorage via `lib/storage.ts`

**UI:** Toggle in `app/(tabs)/more.tsx` - Settings screen

## Dependencies

### Mobile App
- `expo-notifications` - Local and push notifications
- `expo-device` - Device detection (physical vs simulator)
- `expo-constants` - Get Expo project ID
- `@notifee/react-native` - Android ongoing notifications
- `@react-native-async-storage/async-storage` - Device ID storage

### Agent Backend
- `node:fs/promises` - Device registry file operations
- `fetch` - HTTP client for Expo Push API
- Standard Node.js (no external push service dependencies)

## Security Considerations

1. **No authentication on test endpoint** - `/notifications/test` is unauthenticated (noted in scout report)
2. **Device ID generation** - Uses `createId('device')` from `lib/defaults.ts`
3. **Token storage** - Push tokens stored in plaintext in `~/.tmux-agent/notifications/devices.json`
4. **Expo Push Service** - Relies on Expo's infrastructure (https://exp.host)

## Testing

**Manual test (mobile app):**
```typescript
// app/(tabs)/more.tsx:9
sendTestNotification() // Local notification
```

**API test (backend):**
```bash
curl -X POST http://localhost:4020/notifications/test \
  -H "Content-Type: application/json" \
  -d '{"title": "Test", "body": "Hello"}'
```

## Future Enhancements (from plan docs)

From `thoughts/shared/plans/PLAN-usage-reset-notifications.md`:
- Scheduled notifications before reset (would need cron)
- In-app notification center (mobile UI)
- Custom notification sounds
- Notification history

## Open Questions

1. **No rate limiting on /notifications/test endpoint** - Could be spammed
2. **Device cleanup** - Old devices never removed from registry
3. **Token expiration** - No handling of expired Expo Push Tokens
4. **Error handling** - Failed push attempts not retried
5. **Notification receipts** - Expo provides receipt checking, not implemented

## Related Files

**Documentation:**
- `thoughts/shared/plans/PLAN-agent-notifications.md` - Initial notification plan
- `thoughts/shared/plans/PLAN-usage-reset-notifications.md` - Usage reset notification plan
- `.claude/cache/agents/scout/output-notification-implementation-1769355177.md` - Previous scout report

**Configuration:**
- `app.json` - Expo notification plugin config
