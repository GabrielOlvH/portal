# Codebase Report: Bridge Project Architecture
Generated: 2026-01-19T08:00:00Z

## Summary
**Bridge** is a React Native mobile app (iOS/Android) for managing tmux sessions and Docker containers across multiple remote hosts. It consists of a mobile frontend built with Expo and a Node.js backend agent that runs on managed servers.

## Project Structure

```
ter/
├── app/                    # Expo Router screens (file-based routing)
│   ├── (tabs)/            # Tab navigation screens
│   │   ├── index.tsx      # Home/sessions tab
│   │   ├── hosts.tsx      # Hosts management
│   │   ├── docker.tsx     # Docker containers
│   │   └── more.tsx       # Settings/more
│   ├── hosts/             # Host management screens
│   │   ├── new.tsx        # Add new host
│   │   └── [id]/          # Dynamic host routes
│   ├── session/           # Terminal session screens
│   ├── projects/          # Project management
│   ├── snippets/          # Quick command snippets
│   └── copilot/           # GitHub Copilot integration
├── components/            # React Native UI components
├── lib/                   # Core logic, state, API client
├── agent/                 # Node.js backend server
│   └── src/
│       ├── http/          # Hono HTTP server + routes
│       └── notifications/ # Notification system
├── assets/                # Images, fonts
└── android/               # Native Android configuration
```

## Questions Answered

### Q1: Is this a monorepo? What packages exist?

**Not a traditional monorepo** (no pnpm workspaces or lerna), but contains 2 separate packages:

| Package | Location | Purpose | Package Manager |
|---------|----------|---------|-----------------|
| **Bridge App** | `/` (root) | React Native mobile app | npm |
| **Agent** | `/agent/` | Node.js backend server | npm |

Each has its own `package.json` and runs independently.

### Q2: What framework is used for the frontend?

**React Native with Expo** (file-based routing)

**Key Technologies:**
- **Framework:** Expo 54.0 (React Native 0.81.5, React 19.1.0)
- **Router:** `expo-router` v6.0 (file-based routing, similar to Next.js)
- **UI:** React Native core components
- **Animations:** `react-native-reanimated` v4.1
- **Gestures:** `react-native-gesture-handler` v2.30
- **Bottom Sheets:** `@gorhom/bottom-sheet` v5.2
- **Icons:** `lucide-react-native` v0.562

**Routing Pattern:**
```
app/(tabs)/index.tsx     → /
app/hosts/new.tsx        → /hosts/new
app/hosts/[id]/edit.tsx  → /hosts/:id/edit (dynamic routes)
```

### Q3: What's the backend architecture?

**Node.js server using Hono framework**

**Entry Point:** `/home/gabrielolv/Documents/Projects/ter/agent/src/index.ts`

**Tech Stack:**
- **Framework:** Hono v4.6 (lightweight web framework)
- **Server:** `@hono/node-server` v1.13
- **WebSocket:** `ws` v8.18
- **PTY:** `node-pty` v1.0 (terminal emulation)
- **Runtime:** Node.js with `tsx` for TypeScript execution

**Architecture:**
```
index.ts (entry)
    ↓
startServer()
    ↓
buildApp() → Hono app with routes
    ↓
attachWebSocketServers() → WS for terminal I/O
```

**API Routes:** (`agent/src/http/routes/`)
| Route File | Purpose | Key Endpoints |
|------------|---------|---------------|
| `core.ts` | Health, ping, host info | `/health`, `/ping`, `/host`, `/usage` |
| `sessions.ts` | Tmux session CRUD | `/sessions` (list, create, kill) |
| `docker.ts` | Docker management | `/docker/*` (containers, images) |
| `ports.ts` | Port forwarding | `/ports` |
| `files.ts` | File system operations | `/files/*` (browse, read) |
| `notifications.ts` | Push notifications | `/notifications/*` |
| `update.ts` | Agent auto-update | `/update/*` |
| `copilot.ts` | GitHub Copilot OAuth | `/copilot/*` |

**WebSocket Servers:**
- Terminal I/O (connects to tmux via node-pty)
- Live updates (session changes, Docker events)

### Q4: How is state management handled?

**React Context + Local Storage** (no Redux/Zustand)

**State Architecture:**
```
app/_layout.tsx (providers hierarchy)
    │
    ├─ QueryProvider (@tanstack/react-query)
    ├─ StoreProvider (lib/store.tsx)
    │   ├─ Hosts management
    │   ├─ App preferences
    │   └─ Persisted to AsyncStorage
    ├─ ProjectsProvider (lib/projects-store.tsx)
    ├─ SnippetsProvider (lib/snippets-store.tsx)
    ├─ ThemeSettingProvider (lib/useTheme.tsx)
    └─ LaunchSheetProvider (lib/launch-sheet.tsx)
```

**Key State Stores:**

| Store | File | Manages | Persistence |
|-------|------|---------|-------------|
| **Store** | `lib/store.tsx` | Hosts, preferences, theme | AsyncStorage |
| **ProjectsProvider** | `lib/projects-store.tsx` | Project bookmarks | AsyncStorage |
| **SnippetsProvider** | `lib/snippets-store.tsx` | Quick command snippets | AsyncStorage |
| **ThemeSettingProvider** | `lib/useTheme.tsx` | Dark/light mode | AsyncStorage |
| **TanStack Query** | `lib/query.tsx` | Server data caching | Memory |

**Storage Layer:** (`lib/storage.ts`)
- Uses `@react-native-async-storage/async-storage`
- Keys: `hosts`, `preferences`, `projects`, `snippets`

**API Client:** (`lib/api.ts`)
- REST client with fetch + timeout handling
- Functions like `getSessions()`, `createSession()`, `getDockerContainers()`
- All requests go through `request<T>(host, path, options)` helper

### Q5: What styling approach is used?

**StyleSheet API + Theme System** (no styled-components or Tailwind)

**Styling Pattern:**
```typescript
import { StyleSheet } from 'react-native';
import { useTheme } from '@/lib/useTheme';

function Component() {
  const { colors } = useTheme();
  
  return <View style={[styles.container, { backgroundColor: colors.background }]} />;
}

const styles = StyleSheet.create({
  container: { padding: 16 }
});
```

**Theme System:**

**Files:**
- `lib/theme.ts` - Theme constants (radii, spacing, shadows)
- `lib/colors.ts` - Color palettes (iOS-inspired)
- `lib/useTheme.tsx` - Theme context provider

**Color System:**
```typescript
// Light theme
lightColors = {
  background: '#F7F3EB',    // Warm cream
  card: '#FFFFFF',          // White cards
  text: '#1A1A1A',          // Bold black
  accent: '#1A1A1A',        // Primary actions
  // Status colors
  green: '#34C759',
  red: '#FF3B30',
  blue: '#007AFF'
}

// Dark theme
darkColors = {
  background: '#000000',    // Pure black
  card: '#1C1C1E',          // iOS dark card
  text: '#FFFFFF',
  accent: '#0A84FF'
}
```

**Design System:**
- Radii: `sm: 10, md: 16, lg: 22, xl: 28`
- Spacing: `xs: 6, sm: 10, md: 16, lg: 22, xl: 28, xxl: 36`
- Fonts: Space Grotesk (UI), JetBrains Mono (terminal)

**No CSS-in-JS libraries** - pure React Native StyleSheet

## Architecture Map

### Mobile App Architecture
```
[User Interface]
        ↓
[Expo Router] → File-based routing (app/)
        ↓
[React Components] (components/)
        ↓
[Context Providers] (lib/store.tsx, etc.)
        ↓
[API Client] (lib/api.ts)
        ↓
[HTTP/WebSocket] → Agent Server
```

### Agent Server Architecture
```
[Entry Point: index.ts]
        ↓
[Hono HTTP Server] (http/app.ts)
    ├─ CORS + Auth Middleware
    ├─ REST Routes (http/routes/)
    └─ WebSocket Servers (http/ws.ts)
        ↓
[Business Logic]
    ├─ tmux.ts → Tmux session management
    ├─ docker.ts → Docker CLI wrapper
    ├─ ports.ts → Port forwarding
    ├─ claude.ts → Claude usage tracking
    ├─ codex.ts → Codex usage tracking
    └─ copilot.ts → Copilot OAuth
        ↓
[System Integration]
    ├─ node-pty → Terminal emulation
    ├─ Child processes → tmux, docker
    └─ File system → Browse/read files
```

## Key Files

### Mobile App

| File | Purpose | Entry Points |
|------|---------|--------------|
| `app/_layout.tsx` | Root layout + providers | `RootLayout()`, `ThemedApp()` |
| `lib/store.tsx` | Global state management | `StoreProvider`, `useStore()` |
| `lib/api.ts` | API client | `getSessions()`, `createSession()`, `getDockerContainers()` |
| `lib/types.ts` | TypeScript types | `Host`, `Session`, `DockerContainer` |
| `lib/theme.ts` | Design tokens | `theme`, `getNavTheme()` |
| `components/LaunchSheet.tsx` | Session launcher modal | `LaunchSheet` |
| `components/HostCard.tsx` | Host list item | `HostCard` |

### Agent Server

| File | Purpose | Entry Points |
|------|---------|--------------|
| `agent/src/index.ts` | Server entry point | `startServer()` |
| `agent/src/server.ts` | Server builder | `startServer()` |
| `agent/src/http/app.ts` | Hono app + routes | `buildApp()` |
| `agent/src/http/ws.ts` | WebSocket servers | `attachWebSocketServers()` |
| `agent/src/tmux.ts` | Tmux integration | `runTmux()`, `listSessions()` |
| `agent/src/docker.ts` | Docker integration | `listContainers()`, `inspectContainer()` |
| `agent/src/state.ts` | Server state | `claudeSession`, `codexSession` |

## Conventions Discovered

### Naming
- **Files:** kebab-case (`host-card.tsx`, `projects-store.tsx`)
- **Components:** PascalCase (`HostCard`, `LaunchSheet`)
- **Functions:** camelCase (`getSessions`, `createSession`)
- **Types:** PascalCase (`Host`, `Session`, `DockerContainer`)

### Patterns

| Pattern | Usage | Example |
|---------|-------|---------|
| Context Provider | State management | `StoreProvider`, `ProjectsProvider` |
| Custom Hooks | State access | `useStore()`, `useTheme()`, `useLaunchSheet()` |
| API Client | Backend communication | `lib/api.ts` functions |
| File-based Routing | Navigation | `app/` directory structure |
| Dynamic Routes | Parameters | `[id]`, `[hostId]`, `[name]` folders |

### File Organization
```
Feature-based routing:
app/hosts/          → Host management screens
app/session/        → Terminal session screens
app/projects/       → Project bookmarks

Shared components:
components/         → Reusable UI components

Business logic:
lib/               → State, API, utilities
```

### TypeScript
- **tsconfig.json:** Extends `expo/tsconfig.base`, strict mode enabled
- **Path alias:** `@/*` maps to project root
- **Agent excluded** from main TS config (has own tsconfig)

## Technology Stack Summary

### Mobile App
| Category | Technology |
|----------|------------|
| Framework | Expo 54.0 + React Native 0.81 + React 19.1 |
| Router | expo-router v6.0 (file-based) |
| State | React Context + TanStack Query v5.90 |
| Storage | AsyncStorage v2.2 |
| Styling | StyleSheet API + custom theme |
| Animations | react-native-reanimated v4.1 |
| Gestures | react-native-gesture-handler v2.30 |
| Icons | lucide-react-native v0.562 |
| Notifications | @notifee/react-native v9.1 |
| Network | @react-native-community/netinfo v11.4 |

### Agent Server
| Category | Technology |
|----------|------------|
| Framework | Hono v4.6 (HTTP) |
| Runtime | Node.js 18+ with tsx (TypeScript) |
| WebSocket | ws v8.18 |
| Terminal | node-pty v1.0 |
| Environment | dotenv v16.4 |
| Deployment | systemd user service |

## Special Features

1. **Multi-host Management:** Store multiple remote hosts with auth tokens
2. **Live Terminal:** WebView + xterm.js with WebSocket communication
3. **Docker Integration:** List/inspect/manage containers and images
4. **Auto-discovery:** Local network scanning for agents
5. **Project Bookmarks:** Quick access to frequently used directories
6. **Command Snippets:** Quick command shortcuts
7. **GitHub Copilot:** OAuth integration for usage tracking
8. **Push Notifications:** iOS/Android notifications for events
9. **Live Activities:** iOS Live Activities support
10. **Agent Auto-update:** Triggered from mobile app

## Installation & Deployment

### Mobile App
```bash
npm install
npm start                 # Development
npm run android           # Android build
npm run ios               # iOS build
```

### Agent
```bash
# Auto-install via curl
curl -sSL https://raw.githubusercontent.com/GabrielOlvH/bridge/main/agent/install.sh | bash

# Manual
cd agent
npm install
npm start                 # Development
npm run dev               # Watch mode

# Service management
systemctl --user status bridge-agent
journalctl --user -u bridge-agent -f
```

## Open Questions
- Is there a CI/CD pipeline? (not visible in repo)
- What's the test coverage? (no test files found)
- How are Docker container terminals handled? (separate implementation from tmux?)
