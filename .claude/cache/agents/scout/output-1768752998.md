# Navbar Dark Mode White Flash Investigation
Generated: 2026-01-18

## Summary
The navbar (NativeTabs) is configured with `tintColor={colors.blue}` which gets its value from the theme context. When interacting with the navbar, React is re-rendering and potentially causing a flash where the theme context temporarily provides the wrong color (light mode blue instead of dark mode blue).

## Root Cause Analysis

### 1. NativeTabs Configuration
**Location:** `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/_layout.tsx:66`

```tsx
<NativeTabs tintColor={colors.blue} minimizeBehavior="onScrollDown">
```

The `tintColor` prop is dynamically set from `colors.blue`, which comes from the `useTheme()` hook.

### 2. Theme System
**Location:** `/home/gabrielolv/Documents/Projects/ter/lib/useTheme.tsx`

Theme colors differ between light and dark modes:

```typescript
// Light mode
export const lightColors = {
  blue: '#007AFF',  // iOS blue
  // ...
}

// Dark mode  
export const darkColors = {
  blue: '#0A84FF',  // Lighter blue for dark mode
  // ...
}
```

The theme is determined by:
```typescript
export function useTheme() {
  const systemScheme = useColorScheme();  // React Native hook
  const themeSetting = useContext(ThemeContext);
  
  const isDark = useMemo(() => {
    if (themeSetting === 'system') {
      return systemScheme === 'dark';
    }
    return themeSetting === 'dark';
  }, [themeSetting, systemScheme]);

  const colors = isDark ? darkColors : lightColors;
  
  return { colors, isDark };
}
```

### 3. State Management in Tab Layout
**Location:** `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/_layout.tsx:1-61`

The component has several state updates that trigger re-renders:
- `useState` for `updateCount` (line 12)
- `useEffect` that polls for updates every 60 seconds (line 34-61)
- Multiple `useMemo` hooks calculating badge counts (lines 14-32)

### 4. Theme Provider Chain
**Location:** `/home/gabrielolv/Documents/Projects/ter/app/_layout.tsx:81-117`

```tsx
<ThemeSettingProvider value={preferences.theme}>
  <ProjectsProvider>
    <LaunchSheetProvider>
      <ThemeProvider value={navTheme}>  // React Navigation theme
        <Stack screenOptions={{ headerShown: false }}>
          <Stack.Screen name="(tabs)" />
          // ...
        </Stack>
      </ThemeProvider>
    </LaunchSheetProvider>
  </ProjectsProvider>
</ThemeSettingProvider>
```

There are TWO theme providers:
1. **ThemeSettingProvider** - Custom theme context (line 81)
2. **ThemeProvider** (React Navigation) - Uses static `navTheme` (line 83)

### 5. React Navigation Theme (POTENTIAL ISSUE)
**Location:** `/home/gabrielolv/Documents/Projects/ter/lib/theme.ts:64-75`

```typescript
export const navTheme = {
  ...DefaultTheme,
  colors: {
    ...DefaultTheme.colors,
    primary: palette.accent,
    background: '#F7F3EB',  // HARDCODED light background
    card: palette.surface,   // HARDCODED white
    text: palette.ink,       // HARDCODED dark text
    border: palette.line,
    notification: palette.blue,
  },
};
```

**CRITICAL:** The `navTheme` is **static** and does not adapt to dark mode! It always uses light mode colors.

## The White Flash Mechanism

When you interact with the navbar:

1. **Touch event** triggers a re-render of the tab layout component
2. During re-render, React Navigation's `ThemeProvider` provides the **static light theme** from `navTheme`
3. This causes a momentary flash where:
   - The navbar background becomes **white** (`card: palette.surface`)
   - Or the entire screen background flashes to **cream** (`background: '#F7F3EB'`)
4. Then the `useTheme()` hook re-evaluates and provides the correct dark colors
5. The navbar returns to the correct dark appearance

## Key Files

| File | Purpose | Issue |
|------|---------|-------|
| `/home/gabrielolv/Documents/Projects/ter/app/(tabs)/_layout.tsx` | Tab bar definition | Uses dynamic `colors.blue` from context |
| `/home/gabrielolv/Documents/Projects/ter/lib/useTheme.tsx` | Custom theme hook | Provides correct light/dark colors |
| `/home/gabrielolv/Documents/Projects/ter/lib/theme.ts` | Navigation theme | **Static theme, no dark mode support** |
| `/home/gabrielolv/Documents/Projects/ter/app/_layout.tsx` | Root layout | Has two theme providers (potential conflict) |

## Potential Causes

### Primary Suspect: Static Navigation Theme
The `navTheme` in `lib/theme.ts` is **not reactive** to dark mode. React Navigation uses this theme for styling native navigation elements, which may include the tab bar background.

### Secondary Suspect: Theme Context Race Condition
When the tab layout re-renders (due to state updates), there might be a brief moment where:
- The ThemeSettingProvider hasn't updated yet
- But React Navigation's ThemeProvider has already rendered with the static light theme

### Tertiary Suspect: NativeTabs Re-mounting
The `minimizeBehavior="onScrollDown"` prop might be causing the NativeTabs to re-mount or re-style, triggering a momentary use of the default/light theme.

## Architecture Map

```
[User taps tab]
       ↓
[Touch event triggers re-render]
       ↓
[Tab Layout re-renders]
       ↓
[NativeTabs re-evaluates tintColor prop]
       ↓
[TWO THEME SOURCES COMPETE:]
       ├─→ [ThemeSettingProvider → useTheme() → darkColors.blue ('#0A84FF')]
       └─→ [React Nav ThemeProvider → navTheme.colors (static light)]
       ↓
[Brief flash of light theme]
       ↓
[Custom theme wins, returns to dark]
```

## Recommendations

### 1. Make Navigation Theme Reactive (HIGH PRIORITY)
Convert `navTheme` from a static object to a function that accepts `isDark` parameter:

```typescript
export const getNavTheme = (isDark: boolean) => ({
  ...DefaultTheme,
  colors: {
    ...DefaultTheme.colors,
    primary: isDark ? darkColors.accent : lightColors.accent,
    background: isDark ? darkColors.background : lightColors.background,
    card: isDark ? darkColors.card : lightColors.card,
    text: isDark ? darkColors.text : lightColors.text,
    border: isDark ? darkColors.border : lightColors.border,
    notification: isDark ? darkColors.blue : lightColors.blue,
  },
});
```

Then in `app/_layout.tsx`, make it reactive:
```tsx
function ThemedApp() {
  const { isDark } = useTheme();
  const navTheme = useMemo(() => getNavTheme(isDark), [isDark]);
  
  return (
    <ThemeProvider value={navTheme}>
      {/* ... */}
    </ThemeProvider>
  );
}
```

### 2. Investigate NativeTabs Props
Check if NativeTabs accepts a `backgroundColor` or `barTintColor` prop that can be explicitly set to dark colors.

### 3. Memoize Tab Layout
The tab layout has multiple state updates. Consider memoizing the `tintColor` to prevent unnecessary re-evaluations:

```tsx
const tabTintColor = useMemo(() => colors.blue, [colors.blue]);

<NativeTabs tintColor={tabTintColor} minimizeBehavior="onScrollDown">
```

### 4. Check for CSS/StyleSheet Overrides
Search for any global styles or iOS-specific styling that might be setting a white background on the tab bar.

## Open Questions

1. Does the flash happen on all tabs or only specific ones?
2. Does it happen on every interaction or only certain gestures (tap vs swipe)?
3. Is the flash visible in iOS Simulator, Expo Go, or production builds (or all)?
4. Are there any console warnings about theme providers when the flash occurs?

## Related Components

- **Screen.tsx** - Uses `useTheme()` for background colors, but correctly adapts to dark mode
- **App.json** - Has hardcoded white for splash screen, but shouldn't affect runtime navbar
- **StatusBar** - Correctly uses `isDark` to set style ('light' or 'dark')
