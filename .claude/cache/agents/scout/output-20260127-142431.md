# Codebase Report: Portal Project Exploration
Generated: 2026-01-27 14:22:00

## Summary

Portal is a cross-platform mobile application (iOS/Android/Web) for remote server management, specifically designed to manage tmux sessions and Docker containers across multiple hosts. It consists of:
- **Frontend**: React Native app built with Expo
- **Backend**: Node.js agent that runs on remote servers
- **Architecture**: Client-server with REST API + WebSocket for terminal I/O

---

## Application Type

**Cross-Platform Mobile Application** with web support

- Primary platforms: iOS & Android (React Native)
- Secondary platform: Web (Progressive Web App)
- Distribution: Expo Application Services (EAS)
- Bundle ID: `com.portal.app`
- Owner: kaiasystems

---

## Technology Stack

### Frontend (Mobile App)

| Category | Technology | Purpose |
|----------|-----------|---------|
| Framework | React Native 0.81.5 + Expo 54.0.32 | Cross-platform mobile development |
| React | React 19.1.0 | UI library |
| Navigation | Expo Router 6.0.22 | File-based routing |
| State Management | @tanstack/react-query 5.90.20 | Server state & caching |
| UI Components | Custom components + native modules | UI layer |
| Styling | React Native + Expo themes | Theming system |
| Notifications | expo-notifications, @notifee/react-native | Push notifications |
| Live Activities | expo-live-activity | iOS Live Activities |
| Animations | react-native-reanimated 4.1.1 | Smooth animations |
| Gestures | react-native-gesture-handler 2.28.0 | Touch interactions |
| Bottom Sheets | @gorhom/bottom-sheet 5.2.8 | Modal interactions |
| Terminal | react-native-webview + xterm.js | Terminal emulation |
| Storage | @react-native-async-storage | Local persistence |
| Network Detection | @react-native-community/netinfo | Network status |

### Backend (Agent)

| Category | Technology | Purpose |
|----------|-----------|---------|
| Runtime | Node.js 18+ | Server runtime |
| Framework | Hono 4.6.10 | Lightweight HTTP framework |
| Server | @hono/node-server 1.13.2 | Node.js adapter |
| WebSocket | ws 8.18.0 | Terminal I/O streaming |
| PTY | node-pty 1.0.0 | Pseudo-terminal management |
| Language | TypeScript 5.9.2 | Type safety |
| Environment | dotenv 16.4.7 | Configuration |
| Process Manager | systemd (Linux) | Service management |

### Development Tools

- **Build**: Expo CLI, Metro bundler
- **Type Checking**: TypeScript strict mode
- **Linting**: oxlint
- **Package Manager**: npm/pnpm
- **Git**: Version control

---

## Project Architecture

```
portal/
├── app/                    # Expo Router screens (file-based routing)
│   ├── (tabs)/            # Tab navigation screens
│   ├── ai-sessions/       # AI session management
│   ├── cli-assets/        # CLI-related assets
│   ├── copilot/           # Copilot integration
│   ├── hosts/             # Host management screens
│   ├── ports/             # Port forwarding UI
│   ├── projects/          # Project management
│   ├── session/           # Terminal session views
│   ├── snippets/          # Quick command snippets
│   └── _layout.tsx        # Root layout & providers
│
├── components/            # Reusable React Native components
│   ├── AnsiText.tsx       # ANSI color rendering
│   ├── Card.tsx           # Card components
│   ├── HostCard.tsx       # Host display card
│   ├── HostForm.tsx       # Host configuration form
│   ├── LaunchSheet.tsx    # Quick launch bottom sheet
│   ├── SessionCard.tsx    # Session list item
│   ├── TerminalWebView.tsx # Terminal rendering
│   ├── TunnelRow.tsx      # SSH tunnel UI
│   └── icons/             # Icon components
│
├── lib/                   # Core business logic
│   ├── api.ts             # API client for agent communication
│   ├── store.tsx          # Global state management
│   ├── types.ts           # TypeScript type definitions
│   ├── theme.ts           # Theme configuration
│   ├── useTheme.tsx       # Theme hook
│   ├── live.tsx           # Live data hooks
│   ├── notifications.ts   # Push notification logic
│   ├── discovery.ts       # Network discovery
│   ├── docker-hooks.ts    # Docker API hooks
│   ├── terminal-html.ts   # Terminal HTML generator
│   └── storage.ts         # AsyncStorage wrapper
│
├── agent/                 # Node.js backend (runs on servers)
│   ├── src/
│   │   ├── index.ts       # Entry point
│   │   ├── server.ts      # Hono server setup
│   │   ├── http/          # HTTP route handlers
│   │   ├── tmux.ts        # tmux session management
│   │   ├── docker.ts      # Docker container management
│   │   ├── ports.ts       # Port forwarding
│   │   ├── tunnels.ts     # SSH tunnel management
│   │   ├── claude.ts      # Claude integration
│   │   ├── copilot.ts     # GitHub Copilot integration
│   │   ├── codex.ts       # Code execution
│   │   ├── agents.ts      # Agent discovery
│   │   ├── usage.ts       # System metrics (CPU, memory, disk)
│   │   ├── pty-runner.ts  # PTY process runner
│   │   └── ws.d.ts        # WebSocket types
│   ├── scripts/           # Installation scripts
│   ├── install.sh         # Agent installer
│   ├── update.sh          # Auto-update script
│   ├── uninstall.sh       # Removal script
│   └── package.json       # Agent dependencies
│
├── assets/                # Static assets (images, fonts)
├── thoughts/              # Documentation/notes
├── package.json           # App dependencies
├── app.json               # Expo configuration
├── tsconfig.json          # TypeScript config
└── README.md              # Project documentation
```

---

## Key Features

### 1. Multi-Host Management
- Add/edit/remove server profiles
- Per-host authentication tokens
- Network auto-discovery of agents
- Host health monitoring

### 2. tmux Session Management
- List all tmux sessions on remote hosts
- Create new sessions
- Kill/rename existing sessions
- Attach to sessions via full terminal

### 3. Docker Container Management
- View running containers
- Start/stop/restart containers
- Container logs
- Container metrics

### 4. Terminal Interface
- Full terminal via WebView + xterm.js
- Text selection (long-press)
- Copy/paste support
- ANSI color rendering
- Real-time streaming via WebSocket

### 5. Port Forwarding & Tunnels
- SSH tunnel creation
- Port forwarding management
- Tunnel status monitoring

### 6. Integrations
- Claude AI sessions
- GitHub Copilot OAuth
- Cursor editor integration

### 7. Quick Actions
- Command snippets for frequent tasks
- Bottom sheet launcher
- Project management

### 8. Auto-Updates
- Agent auto-update triggered from app
- systemd service integration
- Zero-downtime updates

---

## Architecture Patterns

### Client-Server Communication

```
[Mobile App] <--REST API--> [Agent Server]
     |                           |
     |                      [tmux sessions]
     |                      [Docker API]
     |                      [System metrics]
     |
     +<---WebSocket--->  [PTY Terminal I/O]
```

### Data Flow

1. **App startup**: Load host profiles from AsyncStorage
2. **Host connection**: REST API `/health` check
3. **Session list**: GET `/sessions` → display in UI
4. **Terminal attach**: 
   - GET `/session/:id/html` → render in WebView
   - WebSocket `/ws` → bidirectional terminal I/O
5. **Live updates**: React Query polling + WebSocket events

### State Management

- **Server State**: TanStack Query (caching, invalidation, refetching)
- **Client State**: React Context + custom stores
- **Persistence**: AsyncStorage for host profiles, snippets, projects
- **Theme**: Custom hook with light/dark mode

---

## Configuration Files

### App Configuration (`app.json`)
```json
{
  "expo": {
    "name": "Portal",
    "slug": "portal",
    "scheme": "portal",
    "newArchEnabled": true,
    "plugins": [
      "expo-router",
      "expo-notifications", 
      "expo-live-activity"
    ]
  }
}
```

### Agent Configuration (`.env`)
```
TMUX_AGENT_PORT=4020
TMUX_AGENT_HOST=my-server
TMUX_AGENT_TOKEN=your-secret-token
```

---

## Build & Deployment

### Development

```bash
# App
pnpm install
pnpm start          # Start Expo dev server
pnpm android        # Run on Android
pnpm ios            # Run on iOS
pnpm web            # Run web version

# Agent
cd agent
npm install
npm run dev         # Development mode with watch
```

### Production

**App**: Built via Expo Application Services (EAS)
- iOS: App Store (bundle: com.portal.app)
- Android: Play Store (package: com.portal.app)
- Web: Static export via Metro

**Agent**: Installed as systemd user service
```bash
curl -sSL https://raw.githubusercontent.com/GabrielOlvH/bridge/main/agent/install.sh | bash
systemctl --user status bridge-agent
```

---

## Entry Points

| Entry Point | Purpose |
|------------|---------|
| `expo-router/entry` | App entry (configured in package.json) |
| `app/_layout.tsx` | Root layout with providers, theme, navigation |
| `agent/src/index.ts` | Agent server entry |
| `agent/install.sh` | Agent installation script |

---

## Notable Implementation Details

### 1. File-Based Routing
Uses Expo Router with typed routes:
- `app/(tabs)/` → Tab navigation
- `app/hosts/[id].tsx` → Dynamic host detail screen
- `app/session/[id].tsx` → Terminal session screen

### 2. Terminal Implementation
- HTML generation: `lib/terminal-html.ts` generates xterm.js HTML
- Rendering: `TerminalWebView.tsx` uses react-native-webview
- I/O: WebSocket bidirectional stream via `ws` library

### 3. Network Discovery
`lib/discovery.ts` implements local network scanning to auto-discover agent servers

### 4. Live Activities (iOS)
Uses `expo-live-activity` for iOS 16+ Dynamic Island integration

### 5. Notifications
- Cross-platform push notifications via expo-notifications
- Android: Notifee for advanced features
- Foreground service for background tasks

### 6. Service Management
Agent runs as systemd user service:
- Auto-restart on failure
- Logging via journalctl
- User-space (no root required)

---

## Dependencies Summary

### Production Dependencies (App): 57 packages
Key: expo, react-native, expo-router, @tanstack/react-query, react-native-webview

### Dev Dependencies (App): 3 packages
Key: typescript, @types/react

### Production Dependencies (Agent): 5 packages
Key: hono, ws, node-pty, dotenv

### Dev Dependencies (Agent): 4 packages
Key: typescript, tsx, @types/node

---

## Open Questions

1. **GitHub repo**: README references `GabrielOlvH/bridge` but project is named "portal" - are these the same?
2. **AI Sessions**: What is the purpose of the `ai-sessions/` directory?
3. **Copilot integration**: How is GitHub Copilot integrated into the terminal workflow?
4. **Cursor integration**: What does the Cursor editor integration provide?
5. **CLI Assets**: Purpose of `cli-assets/` directory unclear
6. **Thoughts directory**: Contains documentation - should be reviewed for architectural decisions

---

## Next Steps for Development

1. Review `thoughts/` directory for architectural context
2. Check `agent/src/claude.ts` for AI integration details
3. Understand the relationship between projects, snippets, and sessions
4. Explore live activity implementation for iOS
5. Review notification strategy for background tasks
