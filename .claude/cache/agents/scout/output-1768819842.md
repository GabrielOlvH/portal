# Codebase Report: Bridge (formerly "Tmux Dock")
Generated: 2026-01-19

## Summary

**Bridge** is a React Native (Expo) mobile application for managing tmux sessions and Docker containers across multiple remote Linux servers. It provides a unified interface to monitor system resources, control terminal sessions, manage containers, and access full terminals on mobile devices (iOS/Android).

The app communicates with a lightweight Node.js agent server that runs on each managed host, providing REST API endpoints and WebSocket terminal access.

---

## What is this app?

**Platform:** Mobile (iOS/Android) via React Native + Expo  
**Target Users:** DevOps engineers, system administrators, developers managing remote Linux servers  
**Core Purpose:** Remote terminal session and Docker container management on mobile

---

## Project Structure

```
ter/
├── app/                  # Expo Router screens (file-based routing)
│   ├── (tabs)/           # Bottom tab navigation
│   │   ├── index.tsx     # Home screen - sessions list
│   │   ├── docker.tsx    # Docker containers across all hosts
│   │   ├── hosts.tsx     # Host management
│   │   └── more.tsx      # Settings/more options
│   ├── hosts/            # Host CRUD screens
│   ├── session/          # Session detail and terminal views
│   ├── ports/            # Port management
│   ├── snippets/         # Quick command snippets
│   ├── projects/         # Project launcher
│   └── copilot/          # GitHub Copilot OAuth flow
│
├── components/           # Reusable React Native components
│   ├── icons/            # Custom icon components
│   ├── SessionCard.tsx   # Session list item with metrics
│   ├── HostCard.tsx      # Host card with status
│   ├── LaunchSheet.tsx   # Project launcher bottom sheet
│   ├── DirectoryBrowser.tsx  # File browser for project selection
│   └── ...
│
├── lib/                  # Core business logic
│   ├── api.ts            # REST client for agent server (30+ endpoints)
│   ├── store.tsx         # Global state (hosts, preferences) via Context
│   ├── types.ts          # TypeScript type definitions
│   ├── live.tsx          # Real-time host status via SSE
│   ├── discovery.ts      # Network scanning for agents
│   ├── docker-hooks.ts   # Docker data aggregation hooks
│   ├── notifications.ts  # Push notifications setup
│   ├── snippets-store.tsx # Quick commands storage
│   ├── projects-store.tsx # Project launcher storage
│   └── ...
│
├── agent/                # Node.js backend server (runs on managed hosts)
│   ├── src/
│   │   ├── http/         # Express routes + WebSocket handlers
│   │   │   ├── routes/   # REST endpoints (sessions, docker, files, etc.)
│   │   │   └── ws.ts     # WebSocket terminal multiplexing
│   │   ├── notifications/# Push notification system
│   │   ├── tmux.ts       # Tmux command wrappers
│   │   ├── docker.ts     # Docker API integration
│   │   ├── copilot.ts    # GitHub Copilot OAuth + usage tracking
│   │   ├── claude.ts     # Claude API wrapper
│   │   ├── diagnostics.ts # System diagnostics
│   │   └── ...
│   ├── install.sh        # Agent installation script
│   └── update.sh         # Auto-update script
│
└── assets/               # Fonts, images, icons
```

---

## Major Features

### 1. **Multi-Host Management**
- Add/edit/remove remote hosts with auth tokens
- Per-host connection settings (URL, port, token)
- Host health monitoring with live status indicators
- System metrics display (CPU, memory, disk)
- Network discovery to find agents on local network

**Implementation:**
- Hosts stored via AsyncStorage (`lib/storage.ts`)
- Health probes via REST API (`lib/api.ts::probeHealth`)
- Live updates via Server-Sent Events (`lib/live.tsx::useHostsLive`)

### 2. **Tmux Session Management**
- View all sessions across all hosts
- Create/kill/rename sessions remotely
- Session insights (git branch, agent state, token usage)
- Quick launch from project templates
- Session search and filtering

**Implementation:**
- REST API: `/sessions` endpoint (`agent/src/http/routes/sessions.ts`)
- UI: `app/(tabs)/index.tsx` (home screen)
- Session card: `components/SessionCard.tsx`

### 3. **Full Terminal Access**
- WebView-based xterm.js terminal
- WebSocket for real-time terminal I/O
- Text selection and copy/paste support
- Terminal resizing
- Binary frame support for efficient data transfer
- Expandable keyboard accessory bar with quick actions

**Implementation:**
- Terminal screen: `app/session/[hostId]/[name]/terminal.tsx`
- WebSocket handler: `agent/src/http/ws.ts`
- PTY management: `agent/src/pty.ts`

### 4. **Docker Container Management**
- View all containers across all hosts
- Start/stop/restart/remove containers
- Exec into running containers via terminal
- Container metrics (CPU, memory, network)
- Image management (list, remove, upload)

**Implementation:**
- Docker API wrapper: `agent/src/docker.ts`
- REST routes: `agent/src/http/routes/docker.ts`
- UI: `app/(tabs)/docker.tsx`
- Hooks: `lib/docker-hooks.ts`

### 5. **Port Management**
- View all listening ports on hosts
- Kill processes by port
- Port forwarding info

**Implementation:**
- Port scanning: `agent/src/ports.ts`
- REST routes: `agent/src/http/routes/ports.ts`
- UI: `app/ports/index.tsx`

### 6. **Project Launcher**
- Quick launch tmux sessions from saved project templates
- Directory browser for project selection
- Recent launches history
- Integration with package.json scripts

**Implementation:**
- Projects store: `lib/projects-store.tsx`
- Launch sheet: `components/LaunchSheet.tsx`
- Directory browser: `components/DirectoryBrowser.tsx`

### 7. **Quick Command Snippets**
- Save frequently-used commands
- Quick send to terminal sessions
- Default snippets (ls, git status, etc.)

**Implementation:**
- Snippets store: `lib/snippets-store.tsx`
- UI: `app/snippets/index.tsx`

### 8. **AI Integration**
- GitHub Copilot OAuth flow
- Copilot usage tracking across hosts
- Claude API integration (agent-side)
- Usage cards on home screen

**Implementation:**
- Copilot OAuth: `agent/src/copilot-oauth.ts`
- Copilot usage: `agent/src/copilot.ts`
- Claude wrapper: `agent/src/claude.ts`
- UI: `app/copilot/auth.tsx`

### 9. **Push Notifications**
- Receive alerts from agent (session paused, etc.)
- Per-host notification registration
- iOS Live Activities integration
- Android ongoing notifications

**Implementation:**
- Notification setup: `lib/notifications.ts`
- Agent-side push: `agent/src/notifications/push.ts`
- Pause monitor: `agent/src/notifications/pause-monitor.ts`
- Live Activity: `lib/live-activity.ts`

### 10. **Auto-Update System**
- Agent can auto-update from GitHub
- Triggered from mobile app
- Systemd service integration

**Implementation:**
- Update script: `agent/update.sh`
- REST endpoint: `agent/src/http/routes/update.ts`

---

## Architecture

### Data Flow

```
[Mobile App] <-- REST API --> [Agent Server] <-- Commands --> [tmux/docker/system]
              <-- WebSocket --> (terminal I/O)
              <-- SSE --> (live updates)
```

### Key Patterns

| Pattern | Implementation |
|---------|----------------|
| **State Management** | React Context API (`lib/store.tsx`, `lib/projects-store.tsx`) |
| **Routing** | Expo Router (file-based in `app/`) |
| **Data Fetching** | TanStack Query (`lib/query.tsx`) with custom hooks |
| **Persistence** | AsyncStorage for hosts, preferences, projects, snippets |
| **Real-time Updates** | Server-Sent Events (SSE) for live host status |
| **Terminal** | WebView + xterm.js + WebSocket with binary frames |
| **API Client** | Central `request()` function with timeout + auth headers |

### Tech Stack

**Mobile App:**
- React Native 0.81.5
- Expo ~54.0.31
- TypeScript 5.9.2
- Expo Router 6.0 (file-based routing)
- TanStack Query 5.90 (data fetching)
- Lucide icons
- Bottom Sheet (@gorhom/bottom-sheet)
- Reanimated 4.1

**Agent Server:**
- Node.js
- Express-like HTTP server
- ws (WebSocket library)
- node-pty (PTY management)
- dockerode (Docker API)

---

## Key Files

| File | Purpose | Entry Points |
|------|---------|--------------|
| **app/_layout.tsx** | Root layout with providers | `RootLayout()` |
| **app/(tabs)/index.tsx** | Home screen - sessions list | Main UI entry |
| **lib/api.ts** | REST client for agent | 30+ API functions |
| **lib/store.tsx** | Global state management | `StoreProvider`, `useStore()` |
| **lib/types.ts** | Type definitions | `Host`, `Session`, `DockerContainer` |
| **lib/live.tsx** | Real-time host status | `useHostsLive()`, `useHostLive()` |
| **agent/src/http/app.ts** | Agent HTTP server setup | Entry point |
| **agent/src/http/ws.ts** | WebSocket terminal handler | Terminal I/O |
| **agent/src/tmux.ts** | Tmux command wrappers | Session management |
| **agent/src/docker.ts** | Docker API integration | Container management |

---

## Recent Development

Based on recent commits and handoff files:

### Completed Features
1. **Expandable Keyboard Accessory** - Quick actions bar for terminal
2. **Snippets System** - Save and send quick commands
3. **Network Discovery** - Auto-find agents on local network
4. **WebSocket Binary Frames** - Efficient terminal I/O
5. **Live Updates** - Real-time session status via SSE
6. **Diagnostics Module** - System health checks on agent
7. **UI Redesign** - Native iOS/Android design patterns

### In Progress (from handoffs)
- GitHub Copilot OAuth implementation
- Usage tracking for AI providers (Claude, Copilot, Codex)
- Agent launcher improvements
- Terminal UX enhancements

---

## Conventions

### Naming
- **Files:** kebab-case (`session-card.tsx`, `api.ts`)
- **Components:** PascalCase (`SessionCard`, `HostForm`)
- **Functions/Hooks:** camelCase (`useHostsLive`, `createSession`)
- **Types:** PascalCase (`Host`, `Session`, `DockerContainer`)

### File Organization
- **Screens:** `app/` directory (Expo Router convention)
- **Components:** `components/` (reusable UI)
- **Business Logic:** `lib/` (API, state, utils)
- **Agent Server:** `agent/src/` (backend code)

### Testing
- No test suite currently detected
- `tsconfig.json` has strict mode enabled
- Type checking via `npm run typecheck`

---

## Open Questions

1. **Deployment:** Is the agent deployed to any production servers?
2. **Testing:** Are there manual QA procedures or automated tests planned?
3. **Error Handling:** What's the most common failure mode (network, WebSocket, auth)?
4. **Performance:** Any known performance issues on older devices?
5. **Features:** What's the roadmap for next features?

---

## Summary for Developer Onboarding

**Bridge** is a mobile-first DevOps tool for managing remote Linux servers via tmux and Docker. It consists of:

1. **React Native App** - Expo-based mobile app with bottom tab navigation
2. **Node.js Agent** - Lightweight server on each managed host providing REST API + WebSocket terminal access

**Core workflows:**
- Add hosts → View sessions/containers → Launch terminals → Execute commands
- Create projects → Quick launch sessions → Monitor AI usage
- Receive push notifications for system events

**Key technologies:**
- Mobile: Expo, React Native, Expo Router, TanStack Query
- Backend: Node.js, Express, ws, node-pty, dockerode
- Real-time: WebSocket (terminal I/O), SSE (status updates)
- Storage: AsyncStorage (mobile), filesystem (agent)

**Recent focus:** UI polish, AI integration (Copilot/Claude), terminal UX improvements, notification system.
